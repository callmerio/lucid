# Lucid 项目结构优化计划

**文档版本**: v1.0
**创建时间**: 2025-05-27 13:55:00 +08:00
**创建原因**: 基于 WXT 最佳实践重新组织项目目录结构，提升开发效率和代码质量

## 项目概述

基于对项目的深入分析和 WXT 最佳实践，制定详细的项目结构优化计划，旨在提升项目的可维护性、开发效率和代码质量。

## 当前问题分析

### 主要问题

1. **目录结构不够规范**：缺少现代化的项目组织方式
2. **开发工具不完整**：缺少测试、代码规范、构建优化等工具
3. **组件架构不清晰**：React 组件没有合理的分层和复用
4. **配置文件分散**：各种配置没有统一管理
5. **文档和类型定义不完善**：缺少完整的类型定义和 API 文档

### 现状评估

- ✅ **基础架构完成**：WXT + React 19 + TypeScript
- ✅ **核心功能实现**：文本选择和基础高亮功能
- ⭕ **开发工具缺失**：测试框架、代码规范工具
- ❌ **项目结构混乱**：文件组织不够清晰
- ❌ **文档不完善**：缺少开发指南和 API 文档

## 优化后的目标结构

```
lucid/
├── .github/                     # GitHub 工作流和模板
│   ├── workflows/
│   │   ├── ci.yml              # 持续集成
│   │   ├── release.yml         # 发布流程
│   │   └── test.yml            # 测试流程
│   ├── ISSUE_TEMPLATE/         # Issue 模板
│   └── pull_request_template.md
├── .vscode/                     # VS Code 配置
│   ├── settings.json
│   ├── extensions.json
│   └── launch.json
├── docs/                        # 项目文档（重命名并重组）
│   ├── architecture/           # 架构文档
│   ├── api/                    # API 文档
│   ├── development/            # 开发指南
│   ├── deployment/             # 部署指南
│   └── user-guide/             # 用户指南
├── src/                         # 源代码目录（新增）
│   ├── components/             # 可复用组件
│   │   ├── ui/                 # 基础 UI 组件
│   │   ├── features/           # 功能组件
│   │   └── layout/             # 布局组件
│   ├── hooks/                  # 自定义 React Hooks
│   ├── services/               # 业务服务层
│   │   ├── api/                # API 客户端
│   │   ├── storage/            # 存储服务
│   │   └── cache/              # 缓存服务
│   ├── types/                  # TypeScript 类型定义
│   ├── constants/              # 常量定义
│   ├── styles/                 # 全局样式
│   └── lib/                    # 工具库和配置
├── entrypoints/                # WXT 入口点（保持现有结构）
│   ├── background.ts
│   ├── content.ts
│   ├── popup/
│   ├── options/                # 新增：设置页面
│   └── devtools/               # 新增：开发者工具
├── utils/                      # 工具函数（保持但重组）
│   ├── dom/                    # DOM 操作工具
│   ├── text/                   # 文本处理工具
│   ├── highlight/              # 高亮相关工具
│   └── validation/             # 验证工具
├── assets/                     # 静态资源
│   ├── icons/                  # 图标资源
│   ├── images/                 # 图片资源
│   └── fonts/                  # 字体资源
├── public/                     # 公共资源（保持现有）
├── tests/                      # 测试文件
│   ├── unit/                   # 单元测试
│   ├── integration/            # 集成测试
│   ├── e2e/                    # 端到端测试
│   └── __mocks__/              # Mock 文件
├── scripts/                    # 构建和部署脚本
│   ├── build.js                # 构建脚本
│   ├── release.js              # 发布脚本
│   └── dev-setup.js            # 开发环境设置
├── config/                     # 配置文件目录
│   ├── eslint.config.js        # ESLint 配置
│   ├── prettier.config.js      # Prettier 配置
│   ├── tailwind.config.js      # Tailwind 配置
│   ├── vitest.config.ts        # Vitest 配置
│   └── playwright.config.ts    # Playwright 配置
├── .env.example                # 环境变量示例
├── .gitignore                  # Git 忽略文件
├── .eslintrc.js                # ESLint 配置
├── .prettierrc                 # Prettier 配置
├── vitest.config.ts            # 测试配置
├── playwright.config.ts        # E2E 测试配置
├── tailwind.config.js          # Tailwind CSS 配置
├── postcss.config.js           # PostCSS 配置
├── tsconfig.json               # TypeScript 配置
├── wxt.config.ts               # WXT 配置（优化）
├── package.json                # 包管理（优化）
├── pnpm-lock.yaml              # 锁定文件
└── README.md                   # 项目说明
```

## 详细实施计划

### 第一阶段：基础结构重组 (1-2 天)

**目标**：建立新的目录结构，重组现有文件

**任务清单**：

1. **创建新的目录结构**

   - [x] 创建 `src/` 目录及其子目录
   - [x] 重组 `docs/` 目录结构
   - [x] 创建 `tests/`、`scripts/`、`config/` 目录

2. **移动和重组现有文件**

   - [x] 将 `utils/` 下的文件按功能重新分类
   - [x] 移动文档文件到新的 `docs/` 结构
   - [x] 整理 `assets/` 和 `public/` 目录

3. **更新导入路径**
   - [x] 配置路径别名 (`@/`, `@components/`, `@utils/` 等)
   - [x] 更新所有文件中的导入路径
   - [x] 确保构建和开发环境正常工作

**验收标准**：

- ✅ 新目录结构创建完成
- ✅ 所有文件正确移动到新位置
- ✅ 项目能够正常构建和运行

### 第二阶段：开发工具集成 (2-3 天)

**目标**：集成现代化开发工具，提升开发体验

**任务清单**：

1. **代码质量工具**

   - [x] 集成 ESLint + TypeScript 规则
   - [x] 配置 Prettier 代码格式化
   - [x] 添加 Husky + lint-staged 预提交钩子

2. **测试框架**

   - [ ] 集成 Vitest 单元测试框架
   - [ ] 配置 Playwright E2E 测试
   - [ ] 创建测试工具和 Mock 文件

3. **构建优化**
   - [ ] 优化 WXT 配置
   - [ ] 添加构建脚本和 CI/CD 配置
   - [ ] 配置多环境构建

**验收标准**：

- 代码质量工具正常工作
- 测试框架完整可用
- 构建流程优化完成

### 第三阶段：组件架构重构 (3-4 天)

**目标**：重构组件架构，建立清晰的代码组织

**任务清单**：

1. **组件系统设计**

   - [ ] 创建基础 UI 组件库
   - [ ] 设计功能组件架构
   - [ ] 实现组件文档和 Storybook

2. **服务层架构**

   - [ ] 重构 API 服务层
   - [ ] 实现存储和缓存服务
   - [ ] 添加错误处理和日志系统

3. **类型系统完善**
   - [ ] 定义完整的 TypeScript 类型
   - [ ] 创建 API 接口定义
   - [ ] 实现类型安全的数据流

**验收标准**：

- 组件架构清晰可扩展
- 服务层设计合理
- 类型定义完整准确

### 第四阶段：文档和工具完善 (1-2 天)

**目标**：完善项目文档和开发工具

**任务清单**：

1. **文档系统**

   - [ ] 重写项目 README
   - [ ] 创建开发指南和部署文档
   - [ ] 添加 API 文档和组件文档

2. **开发体验优化**
   - [ ] 配置 VS Code 工作区
   - [ ] 添加调试配置
   - [ ] 创建开发脚本和工具

**验收标准**：

- 文档完善易懂
- 开发体验优化
- 工具配置完整

## 关键配置文件优化

### 1. 优化后的 `package.json`

```json
{
  "name": "lucid-extension",
  "version": "1.0.0",
  "description": "智能高亮与查词浏览器扩展",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "wxt",
    "dev:firefox": "wxt -b firefox",
    "build": "wxt build",
    "build:firefox": "wxt build -b firefox",
    "zip": "wxt zip",
    "zip:firefox": "wxt zip -b firefox",
    "compile": "tsc --noEmit",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "lint": "eslint . --ext .ts,.tsx,.js,.jsx",
    "lint:fix": "eslint . --ext .ts,.tsx,.js,.jsx --fix",
    "format": "prettier --write .",
    "format:check": "prettier --check .",
    "type-check": "tsc --noEmit",
    "prepare": "husky install",
    "postinstall": "wxt prepare"
  },
  "dependencies": {
    "lodash-es": "^4.17.21",
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "zustand": "^4.4.7"
  },
  "devDependencies": {
    "@types/lodash-es": "^4.17.12",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.3",
    "@wxt-dev/module-react": "^1.1.3",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "@vitest/ui": "^1.0.0",
    "@playwright/test": "^1.40.0",
    "autoprefixer": "^10.4.21",
    "eslint": "^8.0.0",
    "eslint-plugin-react": "^7.33.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "husky": "^8.0.0",
    "lint-staged": "^15.0.0",
    "postcss": "^8.5.3",
    "prettier": "^3.0.0",
    "tailwindcss": "^3.3.0",
    "typescript": "^5.8.3",
    "vitest": "^1.0.0",
    "wxt": "^0.20.6"
  },
  "lint-staged": {
    "*.{ts,tsx,js,jsx}": ["eslint --fix", "prettier --write"],
    "*.{md,json}": ["prettier --write"]
  }
}
```

### 2. 优化后的 `wxt.config.ts`

```typescript
import { defineConfig } from 'wxt';
import { resolve } from 'path';

export default defineConfig({
  modules: ['@wxt-dev/module-react'],
  srcDir: 'src',
  alias: {
    '@': resolve(__dirname, 'src'),
    '@components': resolve(__dirname, 'src/components'),
    '@utils': resolve(__dirname, 'utils'),
    '@services': resolve(__dirname, 'src/services'),
    '@types': resolve(__dirname, 'src/types'),
    '@hooks': resolve(__dirname, 'src/hooks'),
  },
  manifest: {
    name: 'Lucid Extension',
    description: '智能高亮与查词浏览器扩展',
    permissions: ['storage', 'tts', 'contextMenus', 'activeTab'],
    host_permissions: [
      // API 权限将在后续添加
    ],
  },
  dev: {
    server: {
      port: 3000,
    },
    browserFlags: [
      '--auto-open-devtools-for-tabs',
      '--enable-features=AutoOpenDevToolsForPopups',
    ],
  },
  build: {
    minify: true,
    sourcemap: true,
  },
});
```

### 3. ESLint 配置 (`.eslintrc.js`)

```javascript
module.exports = {
  root: true,
  env: {
    browser: true,
    es2020: true,
    webextensions: true,
  },
  extends: [
    'eslint:recommended',
    '@typescript-eslint/recommended',
    'plugin:react/recommended',
    'plugin:react-hooks/recommended',
  ],
  ignorePatterns: ['dist', '.eslintrc.js'],
  parser: '@typescript-eslint/parser',
  plugins: ['react-refresh'],
  rules: {
    'react-refresh/only-export-components': [
      'warn',
      { allowConstantExport: true },
    ],
    'react/react-in-jsx-scope': 'off',
  },
  settings: {
    react: {
      version: 'detect',
    },
  },
};
```

### 4. Prettier 配置 (`.prettierrc`)

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2,
  "useTabs": false
}
```

### 5. Vitest 配置 (`vitest.config.ts`)

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import { resolve } from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@components': resolve(__dirname, 'src/components'),
      '@utils': resolve(__dirname, 'utils'),
      '@services': resolve(__dirname, 'src/services'),
      '@types': resolve(__dirname, 'src/types'),
      '@hooks': resolve(__dirname, 'src/hooks'),
    },
  },
});
```

## 迁移策略

### 文件迁移映射

| 当前位置                    | 新位置                                  | 说明                 |
| --------------------------- | --------------------------------------- | -------------------- |
| `doc/`                      | `docs/`                                 | 重命名并重组文档结构 |
| `utils/selectionUtils.ts`   | `utils/text/selectionUtils.ts`          | 按功能分类           |
| `utils/highlightUtils.ts`   | `utils/highlight/highlightUtils.ts`     | 按功能分类           |
| `entrypoints/popup/App.tsx` | `src/components/features/popup/App.tsx` | 组件化重构           |
| 新增                        | `src/services/`                         | 业务服务层           |
| 新增                        | `src/types/`                            | 类型定义             |
| 新增                        | `tests/`                                | 测试文件             |

### 导入路径更新

```typescript
// 旧的导入方式
import { expandSelectionToFullWord } from '../utils/selectionUtils';
import { applyWordHighlight } from '../utils/highlightUtils';

// 新的导入方式
import { expandSelectionToFullWord } from '@utils/text/selectionUtils';
import { applyWordHighlight } from '@utils/highlight/highlightUtils';
import { WordLookupService } from '@services/api/wordLookupService';
import type { HighlightData } from '@types/highlight';
```

## 验收标准

### 结构清晰性

- ✅ 目录结构符合现代前端项目标准
- ✅ 文件组织逻辑清晰，易于维护
- ✅ 导入路径简洁明了

### 开发体验

- ✅ 代码质量工具正常工作
- ✅ 测试框架完整可用
- ✅ 构建和开发流程顺畅

### 可维护性

- ✅ 组件架构清晰可扩展
- ✅ 类型定义完整准确
- ✅ 文档完善易懂

### 性能优化

- ✅ 构建产物优化
- ✅ 开发环境响应快速
- ✅ 代码分割合理

## 风险评估

### 潜在风险

1. **迁移过程中的构建错误**

   - 风险：导入路径更新不完整导致构建失败
   - 缓解：分阶段迁移，每个阶段都确保构建成功

2. **功能回归**

   - 风险：重构过程中可能影响现有功能
   - 缓解：保持现有功能不变，仅重组结构

3. **开发工具配置冲突**
   - 风险：新工具配置可能与现有设置冲突
   - 缓解：逐步集成，充分测试

### 缓解措施

- 创建备份分支
- 分阶段实施，每阶段验证
- 保持现有功能完整性
- 充分测试新配置

## 后续优化建议

### 短期优化 (1-2 周)

1. **Storybook 集成**：为组件库添加可视化文档
2. **CI/CD 优化**：完善自动化构建和部署流程
3. **性能监控**：添加构建时间和包大小监控

### 中期优化 (1-2 月)

1. **微前端架构**：考虑将不同功能模块独立化
2. **国际化支持**：添加多语言支持框架
3. **主题系统**：建立完整的设计系统

### 长期规划 (3-6 月)

1. **插件化架构**：支持第三方插件扩展
2. **云端同步**：完善数据同步和备份机制
3. **企业版功能**：添加团队协作和管理功能

## 总结

这个项目结构优化计划将显著提升 Lucid 扩展项目的：

- **开发效率**：通过现代化工具链和清晰的项目结构
- **代码质量**：通过完善的测试和代码规范
- **可维护性**：通过模块化设计和完整的文档
- **团队协作**：通过统一的开发标准和工作流

实施完成后，项目将具备现代化前端项目的所有特征，为后续功能开发和团队扩展奠定坚实基础。

## 更新记录

### v1.0 (2025-05-27)

- 初始项目结构优化计划
- 基于 WXT 最佳实践制定
- 包含详细的实施步骤和配置文件
- 提供完整的验收标准和风险评估
