# Lucid 浏览器插件架构文档

**文档版本**: v1.0  
**创建时间**: 2025-01-27 13:00:00 +08:00  
**创建原因**: 记录浏览器插件项目的架构设计和技术实现方案

## 架构概览

Lucid 浏览器插件采用现代化的 WebExtension 架构，基于 WXT 框架构建，实现智能文本高亮和查词功能。插件采用模块化设计，支持跨浏览器兼容性。

### 核心架构原则

- **模块化设计**: 清晰的功能模块分离和组合
- **跨浏览器兼容**: 统一的 WebExtension API 抽象
- **性能优先**: 最小化对网页性能的影响
- **用户体验**: 直观的交互设计和响应式界面

## 技术栈架构

### 框架层

```
WXT (WebExtension Tools)
├── Vite 构建系统
├── TypeScript 类型支持
├── 热重载开发环境
└── 多浏览器打包支持
```

### 前端层

```
React 19
├── 函数式组件 + Hooks
├── TypeScript 类型安全
├── TailwindCSS 样式系统
└── 组件化 UI 设计
```

### 扩展架构

```
WebExtension Manifest V3
├── Content Scripts (内容脚本)
├── Background Scripts (后台脚本)
├── Popup (弹出窗口)
├── Options (设置页面)
└── Storage (本地存储)
```

## 插件架构组件

### 已实现的架构组件

#### 入口点结构

```
entrypoints/
├── background.ts         # 后台脚本 ✅
│   ├── 上下文菜单管理
│   ├── 扩展生命周期
│   └── 消息传递中心
├── content.ts           # 内容脚本 ✅
│   ├── 文本选择监听
│   ├── 高亮功能实现
│   ├── DOM 操作管理
│   └── 主题检测
└── popup/               # 弹出窗口 ✅
    ├── index.html       # 入口页面
    ├── main.tsx         # React 入口
    ├── App.tsx          # 主应用组件
    └── style.css        # 样式文件
```

#### 工具函数模块

```
utils/
├── selectionUtils.ts    # 文本选择处理 ✅
│   ├── 智能单词边界检测
│   ├── 选择范围扩展
│   └── 文本清理和格式化
└── highlightUtils.ts    # 高亮应用逻辑 ✅
    ├── 高亮样式应用
    ├── 主题适配
    └── 颜色梯度计算
```

### 待实现的架构组件

#### 服务层

```
services/
├── apiService.ts        # API 客户端服务
│   ├── 后端 API 调用
│   ├── 请求重试机制
│   └── 错误处理
├── cacheService.ts      # 本地缓存管理
│   ├── 查词结果缓存
│   ├── LRU 缓存策略
│   └── 缓存过期管理
└── syncService.ts       # 数据同步服务
    ├── 云端数据同步
    ├── 冲突解决
    └── 离线支持
```

#### 存储层

```
storage/
├── settingsStorage.ts   # 用户设置存储
│   ├── 主题偏好
│   ├── 快捷键配置
│   └── 功能开关
├── highlightStorage.ts  # 高亮数据存储
│   ├── 高亮记录管理
│   ├── 网站数据隔离
│   └── 数据压缩优化
└── wordStorage.ts       # 生词本存储
    ├── 生词记录管理
    ├── 学习进度跟踪
    └── 分类标签系统
```

#### 组件系统

```
components/
├── WordLookup/          # 查词组件
│   ├── SearchInput.tsx
│   ├── ResultDisplay.tsx
│   ├── Pronunciation.tsx
│   └── AddToVocab.tsx
├── HighlightManager/    # 高亮管理组件
│   ├── HighlightList.tsx
│   ├── ColorPicker.tsx
│   ├── FilterControls.tsx
│   └── BatchActions.tsx
├── Settings/            # 设置组件
│   ├── ThemeSelector.tsx
│   ├── ShortcutConfig.tsx
│   ├── SyncSettings.tsx
│   └── DataManagement.tsx
└── Statistics/          # 统计组件
    ├── LearningProgress.tsx
    ├── UsageStats.tsx
    ├── WordFrequency.tsx
    └── Charts.tsx
```

## 数据流架构

### 消息传递架构

```
Background Script (中心枢纽)
├── Content Script 通信
│   ├── 高亮数据同步
│   ├── 选择文本传递
│   └── 设置更新通知
├── Popup 通信
│   ├── 查词请求处理
│   ├── 设置数据交换
│   └── 统计信息获取
└── 外部 API 通信
    ├── 后端 API 调用
    ├── 认证令牌管理
    └── 数据同步协调
```

### 存储架构

```
Browser Storage API
├── chrome.storage.local (本地数据)
│   ├── 用户设置
│   ├── 高亮数据
│   ├── 缓存数据
│   └── 离线数据
├── chrome.storage.sync (同步数据)
│   ├── 用户偏好
│   ├── 快捷键配置
│   └── 基础设置
└── IndexedDB (大容量数据)
    ├── 查词历史
    ├── 生词本数据
    └── 学习统计
```

## 功能模块架构

### 高亮系统架构

```
高亮功能模块
├── 文本选择检测
│   ├── 鼠标事件监听
│   ├── 键盘快捷键
│   └── 右键菜单触发
├── 智能边界扩展
│   ├── 单词边界检测
│   ├── 标点符号处理
│   └── 多语言支持
├── 高亮样式应用
│   ├── 颜色梯度计算
│   ├── 主题适配
│   └── 动画效果
└── 持久化存储
    ├── 高亮数据序列化
    ├── 网站隔离存储
    └── 数据压缩优化
```

### 查词系统架构

```
查词功能模块
├── API 集成层
│   ├── 后端 API 调用
│   ├── 请求队列管理
│   ├── 错误重试机制
│   └── 响应数据处理
├── 缓存管理层
│   ├── 本地缓存策略
│   ├── 缓存命中检测
│   ├── 过期数据清理
│   └── 缓存统计分析
├── 结果展示层
│   ├── 词汇信息展示
│   ├── 发音播放功能
│   ├── 释义格式化
│   └── 相关词汇推荐
└── 学习跟踪层
    ├── 查词历史记录
    ├── 生词本管理
    ├── 学习进度统计
    └── 复习提醒功能
```

## 性能优化架构

### 内存管理

```
内存优化策略
├── 组件懒加载
│   ├── 动态导入组件
│   ├── 路由级别分割
│   └── 按需加载资源
├── 数据缓存优化
│   ├── LRU 缓存算法
│   ├── 内存使用监控
│   └── 自动垃圾回收
└── DOM 操作优化
    ├── 虚拟滚动
    ├── 事件委托
    └── 防抖节流
```

### 网络优化

```
网络性能优化
├── 请求合并
│   ├── 批量查词请求
│   ├── 数据预加载
│   └── 请求去重
├── 离线支持
│   ├── Service Worker
│   ├── 离线缓存
│   └── 网络状态检测
└── 数据压缩
    ├── 请求数据压缩
    ├── 响应数据解压
    └── 传输优化
```

## 安全架构

### 内容安全

```
安全措施
├── CSP 兼容性
│   ├── 内联脚本避免
│   ├── 外部资源限制
│   └── 安全策略适配
├── 数据验证
│   ├── 输入数据校验
│   ├── API 响应验证
│   └── 存储数据检查
└── 权限管理
    ├── 最小权限原则
    ├── 敏感权限申请
    └── 用户授权确认
```

### 隐私保护

```
隐私保护机制
├── 数据最小化
│   ├── 必要数据收集
│   ├── 本地数据优先
│   └── 定期数据清理
├── 用户控制
│   ├── 数据导出功能
│   ├── 数据删除选项
│   └── 隐私设置面板
└── 透明度
    ├── 数据使用说明
    ├── 隐私政策
    └── 权限说明
```

## 兼容性架构

### 浏览器兼容性

```
跨浏览器支持
├── Chrome/Chromium
│   ├── Manifest V3 支持
│   ├── 最新 API 特性
│   └── 性能优化
├── Firefox
│   ├── WebExtensions API
│   ├── 特定 API 适配
│   └── 功能降级处理
├── Edge
│   ├── Chromium 内核
│   ├── 微软特定功能
│   └── 企业环境支持
└── Safari (计划)
    ├── Safari Extensions
    ├── iOS 支持
    └── macOS 集成
```

### 网站兼容性

```
网站适配策略
├── 通用适配
│   ├── 标准 DOM 操作
│   ├── CSS 选择器兼容
│   └── 事件处理统一
├── 特殊网站处理
│   ├── SPA 应用适配
│   ├── 动态内容处理
│   └── 框架特定优化
└── 兼容性测试
    ├── 主流网站测试
    ├── 边缘案例处理
    └── 性能影响评估
```

## 部署架构

### 开发环境

```
开发工具链
├── WXT 开发服务器
│   ├── 热重载支持
│   ├── 自动刷新
│   └── 开发者工具
├── TypeScript 编译
│   ├── 类型检查
│   ├── 代码转换
│   └── 源码映射
└── 构建优化
    ├── 代码分割
    ├── 资源压缩
    └── 打包优化
```

### 生产部署

```
发布流程
├── 多浏览器构建
│   ├── Chrome Web Store
│   ├── Firefox Add-ons
│   ├── Edge Add-ons
│   └── 手动安装包
├── 版本管理
│   ├── 语义化版本
│   ├── 更新日志
│   └── 兼容性说明
└── 质量保证
    ├── 自动化测试
    ├── 手动测试
    └── 性能基准
```

## 架构优势

### 已实现优势

1. **现代化技术栈**: WXT + React 19 + TypeScript 提供优秀的开发体验
2. **跨浏览器兼容**: 统一的 WebExtension API 抽象
3. **模块化设计**: 清晰的代码组织和功能分离
4. **类型安全**: 端到端的 TypeScript 类型保护
5. **开发效率**: 热重载和自动化工具链

### 计划中的优势

1. **高性能**: 优化的缓存策略和内存管理
2. **用户体验**: 直观的界面设计和流畅的交互
3. **数据安全**: 完善的隐私保护和安全措施
4. **可扩展性**: 插件化的功能模块设计

## 技术债务和改进点

### 当前技术债务

1. **API 集成**: 与后端服务的集成尚未完成
2. **数据持久化**: 高亮数据的本地存储需要实现
3. **用户界面**: Popup 和设置页面需要完善
4. **测试覆盖**: 单元测试和集成测试不足

### 架构改进计划

1. **组件库**: 建立统一的 UI 组件库
2. **状态管理**: 引入状态管理解决方案
3. **错误监控**: 集成错误追踪和性能监控
4. **国际化**: 支持多语言本地化

## 更新记录

### v1.0 (2025-01-27)

- 初始架构文档创建
- 记录当前插件架构设计
- 分析技术栈和组件结构
- 规划未来架构演进方向
