### **PRD v5: Lucid 智能词典扩展 (功能优化版)**

**版本:** 2.1  
**状态:** 开发就绪  
**更新日期:** 2025年1月27日  
**优化重点:** 功能架构重构、交互细节完善、技术实现优化

---

#### **1. 背景与愿景 (Background & Vision)**

**1.1. 项目背景:**
Lucid 浏览器扩展已完成新架构重构，建立了高性能的 Tooltip 管理系统。当前需要在稳固的技术基础上，完善产品功能体验，提升用户的词汇学习效率。基于 99.7% 的测试通过率，产品已具备了可靠的技术保障。

**1.2. 产品愿景:**
将 Lucid 打造为**最智能的浏览器词典扩展**，通过先进的Tooltip系统和个性化学习记录，让用户在自然阅读中无感知地提升词汇量。

**1.3. 核心价值主张:**
- **无干扰学习**: 在不打断阅读流程的前提下提供即时词汇帮助
- **智能记忆**: 基于用户行为数据，智能调整词汇显示优先级  
- **渐进式增强**: 从基础查词到高级学习功能的平滑升级路径

---

#### **2. 功能优先级规划 (Feature Prioritization)**

**2.1. 功能分层架构 (MoSCoW方法)**

| 优先级 | 功能模块 | 核心价值 | 开发周期 |
|--------|----------|----------|----------|
| **Must Have** | 核心Tooltip引擎 | 基础查词体验 | 2周 |
| **Should Have** | 高级显示模式 | 个性化体验 | 3周 |
| **Could Have** | 智能侧边栏 | 学习管理 | 2周 |
| **Won't Have** | AI助教功能 | 未来扩展 | 待定 |

**2.2. 核心目标与衡量指标**

| 核心目标 | 关键结果 (KR) | 测量方法 |
|---------|---------------|----------|
| **提升查词效率** | 查词响应时间 P95 < 300ms | 性能监控 |
| **增强用户体验** | 用户满意度 > 4.5/5.0 | 用户调研 |
| **保证系统稳定** | 错误率 < 0.1% | 错误日志 |

---

#### **3. 功能模块详细设计**

### **模块1: 核心Tooltip引擎** (基础层)

**FR-1.1: 智能Tooltip显示系统**

**功能描述**: 基于新架构的高性能词汇查询和显示系统

**用户故事**: 作为用户，我希望在鼠标悬浮任何单词时都能快速获得准确的释义，且不影响我的阅读流程。

**详细验收标准**:

✅ **响应性能**:
- 鼠标悬浮触发延迟: ≤ 100ms (P95)
- Tooltip显示动画: 200ms 淡入效果
- 内容加载完成: ≤ 300ms (本地缓存) / ≤ 800ms (网络请求)

✅ **交互逻辑**:
- 鼠标移出单词区域后，延迟500ms隐藏Tooltip
- 鼠标移入Tooltip区域时，取消隐藏计时器
- 连续悬浮多个单词时，平滑切换内容，无闪烁

✅ **位置计算**:
- 智能避让视口边界，优先级: 上方 > 下方 > 左侧 > 右侧
- 与目标单词保持8px间距
- 在移动设备上自动调整为底部固定显示

✅ **错误处理**:
- 网络超时(>3s): 显示"查询超时，点击重试"
- API错误: 显示"暂时无法查询，请稍后重试"  
- 未知单词: 显示"未找到释义，建议检查拼写"

**FR-1.2: 键盘快捷键支持**

✅ **快捷键定义**:
- `Ctrl/Cmd + Shift + L`: 切换扩展启用/禁用状态
- `Escape`: 关闭当前显示的Tooltip
- `Space`: 展开/收起Tooltip详细信息
- `Tab`: 在Tooltip内容间导航

---

### **模块2: 高级显示模式** (增强层)

**FR-2.1: 模式切换管理系统**

**功能描述**: 支持沉浸式高亮和行内翻译两种显示模式的无缝切换

**模式定义与优先级**:
1. **沉浸式模式** (默认): 悬浮显示，不修改页面DOM
2. **行内翻译模式**: 直接在页面中注入翻译，适合精读场景
3. **禁用模式**: 完全关闭功能，保持页面原始状态

**状态管理规则**:

✅ **模式切换**:
- 切换生效时间: ≤ 200ms
- 当前页面立即应用新模式，无需刷新
- 模式状态持久化到browser.storage.local

✅ **冲突处理**:
- 行内翻译模式下，禁用Tooltip显示
- 模式切换时，清理前一模式的DOM修改
- 异常情况下自动回退到沉浸式模式

**FR-2.2: 行内翻译增强功能**

**用户故事**: 作为精读用户，我希望能直接在页面中看到生词翻译，无需额外操作就能理解文章内容。

✅ **DOM注入策略**:
- 使用DocumentFragment批量操作，减少重排
- 仅处理可见区域内容，滚动时延迟加载
- 保持原始DOM结构，使用CSS transform实现视觉效果

✅ **性能优化**:
- 单次处理文本节点数量限制: ≤ 100个
- 使用requestIdleCallback进行后台处理
- 内存占用监控: 增量 ≤ 20MB

✅ **视觉效果**:
- 默认模糊度: blur(2px)，悬浮时0.15s内完全清晰
- 翻译文本颜色: 主题色的60%透明度
- 支持用户自定义模糊度: 0-5px可调

**FR-2.3: 动态样式系统**

✅ **样式自定义**:
- 高亮颜色: 支持16种预设颜色 + 自定义色彩
- 透明度调节: 10%-90%可调，默认30%
- 字体样式: 支持加粗、斜体、下划线组合
- 动画效果: 淡入/滑入/缩放三种动画可选

✅ **实时预览**:
- 设置变更立即在当前页面生效
- 提供"重置为默认"一键恢复
- 设置冲突时显示警告提示

---

### **模块3: 智能侧边栏系统** (管理层)

**FR-3.1: 侧边栏核心功能**

**功能描述**: 提供当前页面词汇管理和快速设置入口

**用户故事**: 作为学习者，我希望能集中查看和管理当前页面的所有生词，快速了解我的学习进度。

**交互设计细节**:

✅ **显示/隐藏逻辑**:
- 点击扩展图标: 300ms滑入动画
- 点击页面其他区域: 自动收起
- 支持ESC键快速关闭
- 记住用户的展开/收起偏好

✅ **内容加载策略**:
- 首次打开: 显示骨架屏，数据加载完成后替换
- 数据获取超时(>2s): 显示重试按钮
- 离线状态: 显示本地缓存数据 + 离线提示

✅ **词汇列表功能**:
- 按出现频次排序，最多显示50个词汇
- 点击词汇: 页面滚动到对应位置 + 高亮闪烁3次
- 支持词汇标记: 已掌握/学习中/困难
- 一键导出当前页面词汇列表

**FR-3.2: 实时设置面板**

✅ **设置项分类**:
- **显示设置**: 模式切换、样式调整、透明度
- **行为设置**: 触发延迟、自动隐藏时间
- **数据设置**: 同步开关、缓存清理

✅ **设置同步**:
- 设置变更立即在当前页面生效
- 跨标签页实时同步设置变更
- 支持设置导入/导出功能

---

### **模块4: 数据同步与存储** (支撑层)

**FR-4.1: 本地数据管理**

✅ **存储策略**:
- 词汇查询缓存: 最多10000条，LRU淘汰
- 用户设置: 实时同步到browser.storage.sync
- 学习记录: 本地优先，定期批量上传

✅ **数据结构优化**:
- 使用IndexedDB存储大量词汇数据
- 压缩算法减少存储空间占用
- 数据版本控制，支持平滑升级

**FR-4.2: 云端同步机制**

✅ **同步时机**:
- 扩展启动时: 拉取最新设置和学习记录
- 数据变更时: 防抖500ms后批量上传
- 浏览器关闭前: 强制同步未上传数据

✅ **冲突解决**:
- 设置冲突: 云端优先，本地备份
- 学习记录冲突: 合并策略，保留最大值
- 网络异常: 本地队列缓存，恢复后重试

---

#### **4. 技术实现细节**

### **4.1. 性能监控与优化**

**关键性能指标 (KPI)**:
- 首次查词响应时间: P95 < 300ms
- 内存占用增量: < 30MB (正常使用)
- CPU占用率: < 5% (空闲时)
- DOM操作频次: < 10次/秒 (行内翻译模式)

**性能优化策略**:
- 词汇预加载: 基于用户阅读习惯预测
- 智能缓存: 热点词汇永久缓存
- 懒加载: 非关键功能延迟初始化
- 降级策略: 性能不足时自动简化功能

### **4.2. 错误处理与用户反馈**

**错误分类与处理**:
1. **网络错误**: 显示重试按钮，支持离线模式
2. **API错误**: 记录错误日志，提供用户反馈入口  
3. **DOM错误**: 自动恢复，避免影响页面正常功能
4. **存储错误**: 清理缓存，重新初始化

**用户反馈机制**:
- 操作成功: 微妙的视觉反馈 (绿色闪烁)
- 操作失败: 明确的错误提示 + 解决建议
- 加载状态: 进度指示器 + 预估时间
- 系统状态: 状态栏图标变化 + 工具提示

### **4.3. 可访问性与兼容性**

**无障碍访问支持**:
- 键盘导航: Tab键遍历所有交互元素
- 屏幕阅读器: ARIA标签完整支持
- 高对比度: 自动适配系统主题
- 字体缩放: 支持200%缩放无布局破坏

**浏览器兼容性**:
- Chrome/Edge: 88+ (主要支持)
- Firefox: 85+ (基础支持)  
- Safari: 14+ (有限支持)
- 移动浏览器: 响应式适配

---

#### **5. 验收测试矩阵**

| 功能模块 | 正常流程测试 | 异常情况测试 | 性能压力测试 | 兼容性测试 |
|---------|-------------|-------------|-------------|-----------|
| 核心Tooltip | ✅ 基础查词流程 | ✅ 网络异常处理 | ✅ 连续查词性能 | ✅ 多浏览器验证 |
| 显示模式 | ✅ 模式切换流程 | ✅ DOM冲突处理 | ✅ 大页面处理 | ✅ 移动端适配 |
| 侧边栏 | ✅ 交互操作流程 | ✅ 数据加载失败 | ✅ 大量词汇显示 | ✅ 屏幕尺寸适配 |
| 数据同步 | ✅ 同步成功流程 | ✅ 冲突解决机制 | ✅ 大数据量同步 | ✅ 网络环境测试 |

---

#### **6. 风险评估与缓解策略**

### **6.1. 技术风险**

| 风险类型 | 概率 | 影响 | 缓解策略 | 负责人 |
|---------|------|------|----------|--------|
| 性能瓶颈 | 中 | 高 | 性能监控+降级方案 | 技术团队 |
| DOM兼容性 | 低 | 中 | 兼容性测试+回退机制 | 前端团队 |
| 数据同步冲突 | 中 | 中 | 冲突检测+合并策略 | 后端团队 |

### **6.2. 产品风险**

| 风险类型 | 概率 | 影响 | 缓解策略 | 负责人 |
|---------|------|------|----------|--------|
| 用户接受度 | 低 | 高 | 用户测试+快速迭代 | 产品团队 |
| 功能复杂度 | 中 | 中 | 分阶段发布+用户引导 | 产品团队 |

---

**文档维护者**: Lucid 产品团队  
**最后更新**: 2025年1月27日  
**下次评审**: 2025年2月10日
