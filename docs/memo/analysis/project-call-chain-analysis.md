# Lucid æµè§ˆå™¨æ‰©å±•é¡¹ç›®è°ƒç”¨é“¾è·¯åˆ†æ

## ğŸ“‹ é¡¹ç›®æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lucid Browser Extension                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entry Points Layer (æ‰©å±•å…¥å£å±‚)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ background  â”‚   content   â”‚    popup    â”‚   options   â”‚     â”‚
â”‚  â”‚   .ts       â”‚    .ts      â”‚    .tsx     â”‚    .tsx     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service Layer (æœåŠ¡å±‚)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PopupServiceâ”‚ DataService â”‚ CacheServiceâ”‚ ApiService  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Manager Layer (ç®¡ç†å™¨å±‚)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ TooltipMgr  â”‚ ToolfullMgr â”‚TransparentMgrâ”‚ EventMgr   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Component Layer (ç»„ä»¶å±‚)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Tooltip   â”‚   Toolfull  â”‚   Popup     â”‚ Highlight   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Utility Layer (å·¥å…·å±‚)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Highlight   â”‚    Text     â”‚    DOM      â”‚   Event     â”‚     â”‚
â”‚  â”‚   Utils     â”‚   Utils     â”‚   Utils     â”‚   Utils     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— æ ¸å¿ƒåŠŸèƒ½è°ƒç”¨é“¾è·¯

### 1. æ‰©å±•å¯åŠ¨æµç¨‹

```
entrypoints/background.ts
â”œâ”€â”€ åˆ›å»ºå³é”®èœå•
â”œâ”€â”€ ç›‘å¬æ‰©å±•å›¾æ ‡ç‚¹å‡»
â””â”€â”€ å¤„ç†æ¶ˆæ¯ä¼ é€’

entrypoints/content.ts
â”œâ”€â”€ åˆå§‹åŒ–ç®¡ç†å™¨
â”‚   â”œâ”€â”€ TooltipManager.getInstance()
â”‚   â”œâ”€â”€ ToolfullManager.getInstance()
â”‚   â””â”€â”€ TransparentPopupManager.getInstance()
â”œâ”€â”€ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
â”‚   â”œâ”€â”€ keyup (Shifté”®é«˜äº®)
â”‚   â””â”€â”€ runtime.onMessage
â””â”€â”€ è¿”å›æ¸…ç†å‡½æ•°
```

### 2. é«˜äº®åŠŸèƒ½è°ƒç”¨é“¾è·¯

```
ç”¨æˆ·é€‰æ‹©æ–‡æœ¬ + Shifté”®
â†“
entrypoints/content.ts::debouncedKeyUp
â†“
handleSelectionAndHighlight()
â”œâ”€â”€ window.getSelection()
â”œâ”€â”€ expandSelectionToFullWord() [src/utils/text/selection.ts]
â”œâ”€â”€ è®¡ç®—æ–‡æœ¬é¢œè‰²å’Œäº®åº¦
â””â”€â”€ applyWordHighlight() [src/utils/highlight/highlightUtils.ts]
    â”œâ”€â”€ è·å–å­˜å‚¨æ•°æ® (browser.storage.local)
    â”œâ”€â”€ è®¡ç®—é«˜äº®æ ·å¼ calculateHighlight()
    â”œâ”€â”€ åˆ›å»ºé«˜äº®å…ƒç´  createHighlightElement()
    â”œâ”€â”€ æ·»åŠ tooltipäº‹ä»¶ addTooltipEvents()
    â”‚   â””â”€â”€ TooltipManager.getInstance().showTooltip()
    â””â”€â”€ æ›´æ–°å­˜å‚¨æ•°æ®
```

### 3. Tooltip æ˜¾ç¤ºè°ƒç”¨é“¾è·¯

```
é¼ æ ‡æ‚¬åœé«˜äº®å…ƒç´ 
â†“
highlightUtils.ts::addTooltipEvents (mouseenter)
â†“
TooltipManager.showTooltip()
â”œâ”€â”€ stateManager.show()
â”œâ”€â”€ è·å–ç¿»è¯‘æ•°æ® (DataService)
â”œâ”€â”€ åˆ›å»ºTooltipç»„ä»¶
â”œâ”€â”€ popupService.show()
â”‚   â”œâ”€â”€ åˆ›å»ºå®¹å™¨å…ƒç´ 
â”‚   â”œâ”€â”€ createRoot()
â”‚   â””â”€â”€ æ¸²æŸ“Popupç»„ä»¶
â””â”€â”€ setupShiftKeyListener()
```

### 4. Shifté”®æ¨¡å¼åˆ‡æ¢è°ƒç”¨é“¾è·¯

```
Tooltipæ˜¾ç¤ºæ—¶æŒ‰Shifté”®
â†“
TooltipManager::setupShiftKeyListener (keydown)
â”œâ”€â”€ ä¸é˜»æ­¢äº‹ä»¶ä¼ æ’­ (å…è®¸é«˜äº®åŠŸèƒ½ç»§ç»­)
â”œâ”€â”€ showDetailedView()
â”‚   â”œâ”€â”€ dataService.getWordDetails()
â”‚   â”œâ”€â”€ åˆ›å»ºToolfullç»„ä»¶
â”‚   â””â”€â”€ popupService.show()
â””â”€â”€ ç§»é™¤ç›‘å¬å™¨
```

### 5. é€æ˜å¼¹çª—è°ƒç”¨é“¾è·¯

```
ç‚¹å‡»æ‰©å±•å›¾æ ‡
â†“
background.ts::action.onClicked
â†“
å‘é€æ¶ˆæ¯åˆ°content.ts
â†“
content.ts::runtime.onMessage
â†“
TransparentPopupManager.toggle()
â”œâ”€â”€ show() / hide()
â”œâ”€â”€ createPopupElement()
â”œâ”€â”€ renderContent() (Reactæ¸²æŸ“)
â”œâ”€â”€ setupEventListeners()
â””â”€â”€ å‘é€å…¨å±€äº‹ä»¶
```

## ğŸ“ æ–‡ä»¶åŠŸèƒ½å¯¹åº”å…³ç³»

### Entry Points (å…¥å£æ–‡ä»¶)

- `entrypoints/background.ts` - åå°è„šæœ¬ï¼Œå¤„ç†å³é”®èœå•å’Œå›¾æ ‡ç‚¹å‡»
- `entrypoints/content.ts` - å†…å®¹è„šæœ¬ï¼Œä¸»è¦ä¸šåŠ¡é€»è¾‘å…¥å£
- `dev/entrypoints/popup/main.tsx` - å¼¹çª—é¡µé¢å…¥å£

### Services (æœåŠ¡å±‚)

- `src/services/PopupService.tsx` - ç»Ÿä¸€å¼¹çª—ç®¡ç†æœåŠ¡
- `src/services/DataService.ts` - æ•°æ®è·å–æœåŠ¡
- `src/services/cache/` - ç¼“å­˜æœåŠ¡
- `src/services/storage/` - å­˜å‚¨æœåŠ¡
- `src/services/api/` - APIæœåŠ¡

### Managers (ç®¡ç†å™¨å±‚)

- `src/utils/dom/managers/tooltip/TooltipManager.tsx` - Tooltipç®¡ç†å™¨
- `src/utils/dom/managers/popup/ToolfullManager.tsx` - Toolfullç®¡ç†å™¨
- `src/utils/dom/managers/popup/TransparentPopupManager.ts` - é€æ˜å¼¹çª—ç®¡ç†å™¨
- `src/utils/dom/simpleEventManager.ts` - äº‹ä»¶ç®¡ç†å™¨

### Components (ç»„ä»¶å±‚)

- `src/components/ui/Tooltip.tsx` - Tooltip UIç»„ä»¶
- `src/components/ui/Toolfull.tsx` - Toolfull UIç»„ä»¶
- `src/components/ui/common/Popup.tsx` - é€šç”¨å¼¹çª—ç»„ä»¶

### Utils (å·¥å…·å±‚)

- `src/utils/highlight/highlightUtils.ts` - é«˜äº®åŠŸèƒ½æ ¸å¿ƒå·¥å…·
- `src/utils/text/selection.ts` - æ–‡æœ¬é€‰æ‹©å·¥å…·
- `src/utils/text/phonetic.ts` - éŸ³æ ‡å¤„ç†å·¥å…·
- `src/utils/dom/` - DOMæ“ä½œå·¥å…·

### Types & Constants (ç±»å‹å’Œå¸¸é‡)

- `src/types/` - ç±»å‹å®šä¹‰
- `src/constants/uiEvents.ts` - UIäº‹ä»¶å¸¸é‡
- `src/styles/` - æ ·å¼æ–‡ä»¶

## ğŸ”„ æ•°æ®æµå‘

### é«˜äº®æ•°æ®æµ

```
ç”¨æˆ·é€‰æ‹© â†’ æ–‡æœ¬å¤„ç† â†’ å­˜å‚¨æ›´æ–° â†’ DOMæ›´æ–° â†’ æ ·å¼åº”ç”¨ â†’ äº‹ä»¶ç»‘å®š
```

### Tooltipæ•°æ®æµ

```
é¼ æ ‡äº‹ä»¶ â†’ ç®¡ç†å™¨å¤„ç† â†’ æ•°æ®è·å– â†’ ç»„ä»¶æ¸²æŸ“ â†’ æœåŠ¡æ˜¾ç¤º â†’ ä½ç½®è®¡ç®—
```

### äº‹ä»¶ä¼ æ’­æµ

```
DOMäº‹ä»¶ â†’ äº‹ä»¶ç®¡ç†å™¨ â†’ çŠ¶æ€ç®¡ç†å™¨ â†’ ç»„ä»¶æ›´æ–° â†’ UIåé¦ˆ
```

## ğŸ¯ å…³é”®æ¨¡å—è¯¦ç»†è°ƒç”¨å…³ç³»

### TooltipManager è°ƒç”¨é“¾

```
TooltipManager.tsx
â”œâ”€â”€ ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ PopupService (å¼¹çª—æ¸²æŸ“)
â”‚   â”œâ”€â”€ DataService (æ•°æ®è·å–)
â”‚   â”œâ”€â”€ TooltipStateManager (çŠ¶æ€ç®¡ç†)
â”‚   â””â”€â”€ React Components (UIç»„ä»¶)
â”œâ”€â”€ æ ¸å¿ƒæ–¹æ³•
â”‚   â”œâ”€â”€ showTooltip() â†’ PopupService.show()
â”‚   â”œâ”€â”€ showDetailedView() â†’ DataService.getWordDetails()
â”‚   â”œâ”€â”€ hideTooltip() â†’ PopupService.hide()
â”‚   â””â”€â”€ setupShiftKeyListener() â†’ DOMäº‹ä»¶ç›‘å¬
â””â”€â”€ çŠ¶æ€ç®¡ç†
    â”œâ”€â”€ stateManager.show/hide()
    â”œâ”€â”€ stateManager.expand/collapse()
    â””â”€â”€ äº‹ä»¶ç›‘å¬å™¨æ¸…ç†
```

### HighlightUtils è°ƒç”¨é“¾

```
highlightUtils.ts
â”œâ”€â”€ æ ¸å¿ƒé«˜äº®åŠŸèƒ½
â”‚   â”œâ”€â”€ toggleWordHighlightState() - åˆ‡æ¢é«˜äº®çŠ¶æ€
â”‚   â”œâ”€â”€ addWordHighlight() - æ·»åŠ é«˜äº®
â”‚   â”œâ”€â”€ removeWordHighlight() - ç§»é™¤é«˜äº®
â”‚   â””â”€â”€ applyWordHighlight() - åº”ç”¨é«˜äº®åˆ°é€‰åŒº
â”œâ”€â”€ æ ·å¼è®¡ç®—
â”‚   â”œâ”€â”€ calculateHighlight() - è®¡ç®—é«˜äº®æ ·å¼
â”‚   â”œâ”€â”€ buildTextGradient() - æ„å»ºæ¸å˜æ ·å¼
â”‚   â””â”€â”€ getEffectiveTextColor() - è·å–æœ‰æ•ˆæ–‡æœ¬é¢œè‰²
â”œâ”€â”€ DOMæ“ä½œ
â”‚   â”œâ”€â”€ createHighlightElement() - åˆ›å»ºé«˜äº®å…ƒç´ 
â”‚   â”œâ”€â”€ highlightWordInContainer() - å®¹å™¨å†…é«˜äº®
â”‚   â””â”€â”€ addTooltipEvents() - æ·»åŠ tooltipäº‹ä»¶
â”œâ”€â”€ å­˜å‚¨æ“ä½œ
â”‚   â”œâ”€â”€ browser.storage.local.get() - è¯»å–å­˜å‚¨
â”‚   â””â”€â”€ browser.storage.local.set() - å†™å…¥å­˜å‚¨
â””â”€â”€ äº‹ä»¶ç»‘å®š
    â””â”€â”€ TooltipManager.getInstance().showTooltip()
```

### PopupService è°ƒç”¨é“¾

```
PopupService.tsx
â”œâ”€â”€ å¼¹çª—ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ show() - æ˜¾ç¤ºå¼¹çª—
â”‚   â”‚   â”œâ”€â”€ åˆ›å»ºå®¹å™¨ document.createElement()
â”‚   â”‚   â”œâ”€â”€ åˆ›å»ºReactæ ¹ createRoot()
â”‚   â”‚   â””â”€â”€ æ¸²æŸ“ç»„ä»¶ root.render()
â”‚   â”œâ”€â”€ hide() - éšè—å¼¹çª—
â”‚   â”‚   â”œâ”€â”€ å¸è½½ç»„ä»¶ root.unmount()
â”‚   â”‚   â””â”€â”€ ç§»é™¤å®¹å™¨ container.remove()
â”‚   â””â”€â”€ update() - æ›´æ–°å¼¹çª—
â”œâ”€â”€ å®ä¾‹ç®¡ç†
â”‚   â”œâ”€â”€ Map<string, PopupInstance> - å¼¹çª—å®ä¾‹æ˜ å°„
â”‚   â””â”€â”€ zIndexCounter - Zè½´å±‚çº§ç®¡ç†
â””â”€â”€ ç»„ä»¶æ¸²æŸ“
    â””â”€â”€ Popupç»„ä»¶ - é€šç”¨å¼¹çª—å®¹å™¨
```

### äº‹ä»¶ç³»ç»Ÿè°ƒç”¨é“¾

```
simpleEventManager.ts
â”œâ”€â”€ å…¨å±€äº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ subscribeGlobalEvent() - è®¢é˜…äº‹ä»¶
â”‚   â”œâ”€â”€ dispatchGlobalEvent() - åˆ†å‘äº‹ä»¶
â”‚   â””â”€â”€ unsubscribeGlobalEvent() - å–æ¶ˆè®¢é˜…
â”œâ”€â”€ DOMäº‹ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ addEventListener() - æ·»åŠ ç›‘å¬å™¨
â”‚   â”œâ”€â”€ removeEventListener() - ç§»é™¤ç›‘å¬å™¨
â”‚   â””â”€â”€ cleanup() - æ‰¹é‡æ¸…ç†
â”œâ”€â”€ äº‹ä»¶ä¼˜å…ˆçº§
â”‚   â”œâ”€â”€ EventPriority.HIGH
â”‚   â”œâ”€â”€ EventPriority.NORMAL
â”‚   â””â”€â”€ EventPriority.LOW
â””â”€â”€ äº‹ä»¶ç»Ÿè®¡
    â”œâ”€â”€ å¤„ç†æ¬¡æ•°ç»Ÿè®¡
    â”œâ”€â”€ æ€§èƒ½ç›‘æ§
    â””â”€â”€ é”™è¯¯å¤„ç†
```

## ğŸ”§ å…³é”®é…ç½®å’Œå¸¸é‡

### UIäº‹ä»¶å¸¸é‡ (uiEvents.ts)

```
UI_EVENTS
â”œâ”€â”€ TOOLTIP
â”‚   â”œâ”€â”€ SHOW - æ˜¾ç¤ºtooltip
â”‚   â”œâ”€â”€ HIDE - éšè—tooltip
â”‚   â””â”€â”€ TRANSITION_TO_POPUP - åˆ‡æ¢åˆ°è¯¦ç»†æ¨¡å¼
â”œâ”€â”€ TOOLPOPUP
â”‚   â”œâ”€â”€ SHOW - æ˜¾ç¤ºè¯¦ç»†å¼¹çª—
â”‚   â””â”€â”€ HIDE - éšè—è¯¦ç»†å¼¹çª—
â”œâ”€â”€ TRANSPARENT_POPUP
â”‚   â”œâ”€â”€ SHOW - æ˜¾ç¤ºé€æ˜å¼¹çª—
â”‚   â”œâ”€â”€ HIDE - éšè—é€æ˜å¼¹çª—
â”‚   â””â”€â”€ TOGGLE - åˆ‡æ¢é€æ˜å¼¹çª—
â””â”€â”€ UI_STATE
    â”œâ”€â”€ HIDE_ALL - éšè—æ‰€æœ‰UI
    â””â”€â”€ STATE_CHANGE - çŠ¶æ€å˜åŒ–
```

### æ ·å¼ç³»ç»Ÿ

```
src/styles/
â”œâ”€â”€ global/
â”‚   â”œâ”€â”€ essential.css - æ ¸å¿ƒæ ·å¼å˜é‡
â”‚   â””â”€â”€ main.css - ä¸»æ ·å¼æ–‡ä»¶
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Tooltip.css - Tooltipæ ·å¼
â”‚   â””â”€â”€ Toolfull.css - Toolfullæ ·å¼
â””â”€â”€ theme/
    â”œâ”€â”€ äº®è‰²ä¸»é¢˜
    â””â”€â”€ æš—è‰²ä¸»é¢˜
```

## ğŸ“Š æ€§èƒ½å…³é”®è·¯å¾„

### é«˜é¢‘è°ƒç”¨è·¯å¾„

1. **é¼ æ ‡æ‚¬åœ** â†’ addTooltipEvents â†’ TooltipManager.showTooltip
2. **Shifté”®** â†’ content.ts keyup â†’ handleSelectionAndHighlight
3. **æ–‡æœ¬é€‰æ‹©** â†’ expandSelectionToFullWord â†’ applyWordHighlight

### å†…å­˜ç®¡ç†å…³é”®ç‚¹

1. **äº‹ä»¶ç›‘å¬å™¨æ¸…ç†** - å„ç®¡ç†å™¨çš„destroy()æ–¹æ³•
2. **Reactç»„ä»¶å¸è½½** - PopupServiceçš„unmount()
3. **å®šæ—¶å™¨æ¸…ç†** - TooltipStateManagerçš„hideTimeout

### å­˜å‚¨è®¿é—®ä¼˜åŒ–

1. **æ‰¹é‡è¯»å†™** - browser.storage.localæ“ä½œ
2. **ç¼“å­˜æœºåˆ¶** - DataServiceç¼“å­˜ç­–ç•¥
3. **é˜²æŠ–å¤„ç†** - debounceåŒ…è£…çš„äº‹ä»¶å¤„ç†å™¨

## ğŸ“‹ åŠŸèƒ½æ¨¡å—è°ƒç”¨æ˜ å°„è¡¨

| åŠŸèƒ½            | å…¥å£æ–‡ä»¶      | æ ¸å¿ƒç®¡ç†å™¨              | ä¸»è¦ç»„ä»¶     | å·¥å…·ç±»            | å­˜å‚¨/æœåŠ¡       |
| --------------- | ------------- | ----------------------- | ------------ | ----------------- | --------------- |
| **æ–‡æœ¬é«˜äº®**    | content.ts    | -                       | -            | highlightUtils.ts | browser.storage |
| **Tooltipæ˜¾ç¤º** | content.ts    | TooltipManager          | Tooltip.tsx  | addTooltipEvents  | PopupService    |
| **è¯¦ç»†å¼¹çª—**    | content.ts    | TooltipManager          | Toolfull.tsx | -                 | DataService     |
| **é€æ˜å¼¹çª—**    | background.ts | TransparentPopupManager | Toolfull.tsx | -                 | -               |
| **æ–‡æœ¬é€‰æ‹©**    | content.ts    | -                       | -            | selection.ts      | -               |
| **äº‹ä»¶ç®¡ç†**    | content.ts    | simpleEventManager      | -            | -                 | -               |
| **çŠ¶æ€ç®¡ç†**    | -             | TooltipStateManager     | -            | -                 | -               |
| **æ ·å¼è®¡ç®—**    | -             | -                       | -            | highlightUtils.ts | -               |
| **æ•°æ®è·å–**    | -             | -                       | -            | -                 | DataService     |
| **ç¼“å­˜ç®¡ç†**    | -             | -                       | -            | -                 | CacheService    |

## ğŸ”— ä¾èµ–å…³ç³»çŸ©é˜µ

### æ ¸å¿ƒä¾èµ–å…³ç³»

```
content.ts
â”œâ”€â”€ ç›´æ¥ä¾èµ–
â”‚   â”œâ”€â”€ TooltipManager âœ“
â”‚   â”œâ”€â”€ ToolfullManager âœ“
â”‚   â”œâ”€â”€ TransparentPopupManager âœ“
â”‚   â”œâ”€â”€ highlightUtils âœ“
â”‚   â””â”€â”€ selection utils âœ“
â””â”€â”€ é—´æ¥ä¾èµ–
    â”œâ”€â”€ PopupService (é€šè¿‡TooltipManager)
    â”œâ”€â”€ DataService (é€šè¿‡TooltipManager)
    â””â”€â”€ React Components (é€šè¿‡PopupService)

TooltipManager.tsx
â”œâ”€â”€ ç›´æ¥ä¾èµ–
â”‚   â”œâ”€â”€ PopupService âœ“
â”‚   â”œâ”€â”€ DataService âœ“
â”‚   â”œâ”€â”€ TooltipStateManager âœ“
â”‚   â”œâ”€â”€ Tooltip Component âœ“
â”‚   â””â”€â”€ Toolfull Component âœ“
â””â”€â”€ é—´æ¥ä¾èµ–
    â”œâ”€â”€ React (é€šè¿‡Components)
    â”œâ”€â”€ browser.storage (é€šè¿‡DataService)
    â””â”€â”€ DOM APIs (é€šè¿‡PopupService)

highlightUtils.ts
â”œâ”€â”€ ç›´æ¥ä¾èµ–
â”‚   â”œâ”€â”€ TooltipManager âœ“
â”‚   â”œâ”€â”€ browser.storage âœ“
â”‚   â””â”€â”€ DOM APIs âœ“
â””â”€â”€ é—´æ¥ä¾èµ–
    â””â”€â”€ PopupService (é€šè¿‡TooltipManager)
```

## ğŸš€ å¯åŠ¨åºåˆ—å›¾

### æ‰©å±•åˆå§‹åŒ–æµç¨‹

```
1. background.ts å¯åŠ¨
   â”œâ”€â”€ åˆ›å»ºå³é”®èœå•
   â”œâ”€â”€ æ³¨å†Œå›¾æ ‡ç‚¹å‡»ç›‘å¬å™¨
   â””â”€â”€ ç­‰å¾…æ¶ˆæ¯

2. content.ts æ³¨å…¥
   â”œâ”€â”€ æ£€æŸ¥iframeä¸Šä¸‹æ–‡
   â”œâ”€â”€ åˆå§‹åŒ–ç®¡ç†å™¨
   â”‚   â”œâ”€â”€ TooltipManager.getInstance()
   â”‚   â”œâ”€â”€ ToolfullManager.getInstance()
   â”‚   â””â”€â”€ TransparentPopupManager.getInstance()
   â”œâ”€â”€ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
   â”‚   â”œâ”€â”€ keyup (Shifté”®)
   â”‚   â””â”€â”€ runtime.onMessage
   â””â”€â”€ è¿”å›æ¸…ç†å‡½æ•°

3. ç”¨æˆ·äº¤äº’å‡†å¤‡å°±ç»ª
   â”œâ”€â”€ æ–‡æœ¬é€‰æ‹© + Shift â†’ é«˜äº®åŠŸèƒ½
   â”œâ”€â”€ é¼ æ ‡æ‚¬åœ â†’ Tooltipæ˜¾ç¤º
   â””â”€â”€ å›¾æ ‡ç‚¹å‡» â†’ é€æ˜å¼¹çª—
```

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºé˜¶æ®µ:
content.ts â†’ Manager.getInstance() â†’ åˆå§‹åŒ–çŠ¶æ€

ä½¿ç”¨é˜¶æ®µ:
ç”¨æˆ·äº¤äº’ â†’ äº‹ä»¶å¤„ç† â†’ çŠ¶æ€æ›´æ–° â†’ UIæ¸²æŸ“

é”€æ¯é˜¶æ®µ:
é¡µé¢å¸è½½ â†’ cleanup() â†’ manager.destroy() â†’ æ¸…ç†èµ„æº
```

### å†…å­˜ç®¡ç†ç­–ç•¥

```
1. å•ä¾‹æ¨¡å¼ - ç®¡ç†å™¨ç±»ä½¿ç”¨å•ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
2. äº‹ä»¶æ¸…ç† - æ¯ä¸ªç®¡ç†å™¨ç»´æŠ¤æ¸…ç†å‡½æ•°æ•°ç»„
3. å®šæ—¶å™¨ç®¡ç† - çŠ¶æ€ç®¡ç†å™¨è´Ÿè´£å®šæ—¶å™¨çš„åˆ›å»ºå’Œæ¸…ç†
4. Reactç»„ä»¶ - PopupServiceè´Ÿè´£ç»„ä»¶çš„æŒ‚è½½å’Œå¸è½½
5. DOMç›‘å¬å™¨ - simpleEventManagerç»Ÿä¸€ç®¡ç†DOMäº‹ä»¶
```
