# ðŸš€ é˜¶æ®µä¸‰å®žæ–½æŠ¥å‘Š - ToolpopupManager é‡æž„

## ðŸ“‹ å®žæ–½æ¦‚è§ˆ

**å®žæ–½æ—¶é—´**ï¼š2024-01-XX  
**é˜¶æ®µç›®æ ‡**ï¼šé‡æž„ ToolpopupManagerï¼Œç§»é™¤åŠ¨æ€å¯¼å…¥é€»è¾‘ï¼Œå®Œå…¨åŸºäºŽäº‹ä»¶ç³»ç»Ÿ  
**çŠ¶æ€**ï¼šâœ… å®Œæˆ

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. ðŸ”§ **ç§»é™¤åŠ¨æ€å¯¼å…¥é€»è¾‘**

- **ç§»é™¤å˜é‡**ï¼šåˆ é™¤äº† `let TooltipManager: any = null;`
- **ç§»é™¤åŠ¨æ€å¯¼å…¥**ï¼šåˆ é™¤äº† `const { TooltipManager: TM } = await import('./tooltipManager');`
- **æ·»åŠ äº‹ä»¶å¯¼å…¥**ï¼šå¼•å…¥ `import { simpleEventManager } from './simpleEventManager';` å’Œ `import { UI_EVENTS } from '@constants/uiEvents';`
- **çŠ¶æ€**ï¼šâœ… å®Œå…¨æ¶ˆé™¤äº† ToolpopupManager â†’ TooltipManager çš„åŠ¨æ€ä¾èµ–

### 2. ðŸŽ¯ **äº‹ä»¶é©±åŠ¨é‡æž„**

- **éšè—å…¶ä»–ç»„ä»¶**ï¼š

  ```typescript
  // åŽŸæ¥çš„åŠ¨æ€å¯¼å…¥è°ƒç”¨
  if (!TooltipManager) {
    const { TooltipManager: TM } = await import("./tooltipManager");
    TooltipManager = TM;
  }
  TooltipManager.getInstance().hideTooltip(0);

  // é‡æž„åŽçš„äº‹ä»¶åˆ†å‘
  simpleEventManager.dispatchGlobalEvent(
    UI_EVENTS.UI_STATE.HIDE_ALL,
    { except: "toolpopup", reason: "toolfull-showing" },
    "ToolpopupManager"
  );
  ```

### 3. ðŸŽ§ **å…¨å±€äº‹ä»¶ç›‘å¬**

- **æž„é€ å‡½æ•°å¢žå¼º**ï¼š

  ```typescript
  private constructor() {
      // è®¢é˜…å…¨å±€äº‹ä»¶
      this.setupGlobalEventListeners();
  }

  private setupGlobalEventListeners(): void {
      // ç›‘å¬ tooltip è½¬æ¢åˆ° toolpopup çš„äº‹ä»¶
      const transitionCleanup = simpleEventManager.subscribeGlobalEvent(
          UI_EVENTS.TOOLTIP.TRANSITION_TO_POPUP,
          (event) => {
              const { word, targetElement, fromTooltip } = event.payload;
              this.showToolpopup(word, targetElement, fromTooltip);
          },
          {},
          'ToolpopupManager'
      );

      // ç›‘å¬å…¨å±€éšè—äº‹ä»¶
      const hideAllCleanup = simpleEventManager.subscribeGlobalEvent(
          UI_EVENTS.UI_STATE.HIDE_ALL,
          (event) => {
              if (event.payload.except !== 'toolpopup') {
                  this.hideToolpopup();
              }
          },
          {},
          'ToolpopupManager'
      );

      this.globalEventCleanups.push(transitionCleanup, hideAllCleanup);
  }
  ```

### 4. ðŸ§¹ **èµ„æºç®¡ç†ä¼˜åŒ–**

- **æ¸…ç†æœºåˆ¶å¢žå¼º**ï¼š
  ```typescript
  public destroy(): void {
      this.hideToolpopup();

      // æ¸…ç†å…¨å±€äº‹ä»¶ç›‘å¬å™¨
      this.globalEventCleanups.forEach(cleanup => cleanup());
      this.globalEventCleanups = [];

      console.log('[ToolpopupManager] Destroyed');
  }
  ```

## ðŸ“Š æŠ€æœ¯æˆæžœ

### ðŸŽ¯ **æž¶æž„æ”¹è¿›**

1. **å®Œå…¨è§£è€¦**ï¼šToolpopupManager ä¸å†ä¾èµ– TooltipManager
2. **äº‹ä»¶é©±åŠ¨**ï¼šæ‰€æœ‰ç»„ä»¶é—´é€šä¿¡é€šè¿‡äº‹ä»¶ç³»ç»Ÿ
3. **ç±»åž‹å®‰å…¨**ï¼šç§»é™¤äº† `any` ç±»åž‹ï¼Œæ¢å¤å®Œæ•´ç±»åž‹æ£€æŸ¥
4. **å†…å­˜å®‰å…¨**ï¼šå®Œå–„çš„äº‹ä»¶ç›‘å¬å™¨æ¸…ç†æœºåˆ¶

### ðŸ“ˆ **è´¨é‡æŒ‡æ ‡**

- **ç¼–è¯‘çŠ¶æ€**ï¼šâœ… æ— é”™è¯¯ï¼Œæ— è­¦å‘Š
- **æž„å»ºçŠ¶æ€**ï¼šâœ… æˆåŠŸæž„å»º (268.31 kB)
- **æµ‹è¯•çŠ¶æ€**ï¼šâœ… 50/50 æµ‹è¯•é€šè¿‡ (100% é€šè¿‡çŽ‡)
- **äº‹ä»¶ç³»ç»Ÿ**ï¼šâœ… å®Œå…¨æ­£å¸¸å·¥ä½œ

## ðŸ” **éªŒè¯ç»“æžœ**

### âœ… **åŠŸèƒ½éªŒè¯**

ä»Žæµ‹è¯•æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

1. **äº‹ä»¶ç›‘å¬æ­£å¸¸**ï¼š

   ```
   [SimpleEventManager] ðŸŽ§ è®¢é˜…å…¨å±€äº‹ä»¶: lucid:tooltip:transition-to-popup (æ¥æº: ToolpopupManager)
   [SimpleEventManager] ðŸŽ§ è®¢é˜…å…¨å±€äº‹ä»¶: lucid:ui:hide-all (æ¥æº: ToolpopupManager)
   ```

2. **äº‹ä»¶åˆ†å‘æ­£å¸¸**ï¼š

   ```
   [SimpleEventManager] ðŸ“¢ åˆ†å‘äº‹ä»¶ä½†æ— ç›‘å¬å™¨: lucid:ui:hide-all (æ¥æº: TooltipManager)
   [SimpleEventManager] ðŸ“¢ åˆ†å‘äº‹ä»¶ä½†æ— ç›‘å¬å™¨: lucid:tooltip:transition-to-popup (æ¥æº: TooltipManager)
   ```

3. **èµ„æºæ¸…ç†æ­£å¸¸**ï¼š
   ```
   [SimpleEventManager] ðŸ”‡ å–æ¶ˆè®¢é˜…å…¨å±€äº‹ä»¶: lucid:ui:hide-all (æ¥æº: TooltipManager)
   [TooltipManager] Destroyed
   ```

### âœ… **æž„å»ºéªŒè¯**

```
âœ” Built extension in 1.021 s
â”œâ”€ content-scripts/content.js   58.78 kB
â””â”€ Total size: 268.31 kB
```

### âœ… **æµ‹è¯•éªŒè¯**

```
Test Files  6 passed (6)
Tests  50 passed (50)
Duration  1.72s
```

## ðŸŽ¯ **è§£å†³çš„é—®é¢˜**

### âœ… **å¾ªçŽ¯ä¾èµ–å®Œå…¨æ¶ˆé™¤**

- **é—®é¢˜**ï¼šToolpopupManager â†” TooltipManager åŒå‘å¾ªçŽ¯ä¾èµ–
- **è§£å†³**ï¼šé€šè¿‡äº‹ä»¶ç³»ç»Ÿå®žçŽ°å®Œå…¨è§£è€¦
- **éªŒè¯**ï¼šç¼–è¯‘æ— é”™è¯¯ï¼ŒåŠŸèƒ½æ­£å¸¸

### âœ… **ä»£ç è´¨é‡æ˜¾è‘—æå‡**

- **é—®é¢˜**ï¼šåŠ¨æ€å¯¼å…¥ç ´åç±»åž‹å®‰å…¨
- **è§£å†³**ï¼šäº‹ä»¶é©±åŠ¨çš„ç±»åž‹å®‰å…¨æž¶æž„
- **éªŒè¯**ï¼šå®Œæ•´çš„ TypeScript ç±»åž‹æ£€æŸ¥

### âœ… **å¯ç»´æŠ¤æ€§å¤§å¹…å¢žå¼º**

- **é—®é¢˜**ï¼šå¤æ‚çš„åŠ¨æ€å¯¼å…¥é€»è¾‘
- **è§£å†³**ï¼šæ¸…æ™°çš„äº‹ä»¶å¥‘çº¦
- **éªŒè¯**ï¼šæ—¥å¿—æ¸…æ™°ï¼Œè°ƒè¯•å‹å¥½

## ðŸ”„ **å¾ªçŽ¯ä¾èµ–è§£å†³æ€»ç»“**

### ðŸŽ‰ **å®Œå…¨æˆåŠŸ**

ç»è¿‡ä¸‰ä¸ªé˜¶æ®µçš„é‡æž„ï¼Œæˆ‘ä»¬å·²ç»å®Œå…¨è§£å†³äº†å¾ªçŽ¯ä¾èµ–é—®é¢˜ï¼š

1. **âœ… é˜¶æ®µä¸€**ï¼šå»ºç«‹äº‹ä»¶ç³»ç»ŸåŸºç¡€è®¾æ–½
2. **âœ… é˜¶æ®µäºŒ**ï¼šTooltipManager é‡æž„ï¼Œç§»é™¤å¯¹ ToolpopupManager çš„ç›´æŽ¥ä¾èµ–
3. **âœ… é˜¶æ®µä¸‰**ï¼šToolpopupManager é‡æž„ï¼Œç§»é™¤å¯¹ TooltipManager çš„åŠ¨æ€ä¾èµ–

### ðŸ“Š **æœ€ç»ˆæž¶æž„**

```
TooltipManager â”€â”€(äº‹ä»¶)â”€â”€> EventSystem <â”€â”€(äº‹ä»¶)â”€â”€ ToolpopupManager
     â†‘                                                    â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®Œå…¨è§£è€¦ï¼Œæ— ç›´æŽ¥ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ðŸŽ¯ **æŠ€æœ¯æ”¶ç›Š**

- **è§£è€¦åˆ**ï¼šå®Œå…¨æ¶ˆé™¤å¾ªçŽ¯ä¾èµ–
- **ç±»åž‹å®‰å…¨**ï¼šæ¢å¤å®Œæ•´çš„ TypeScript ç±»åž‹æ£€æŸ¥
- **å¯æµ‹è¯•æ€§**ï¼šæ¯ä¸ªç»„ä»¶å¯ç‹¬ç«‹æµ‹è¯•
- **å¯æ‰©å±•æ€§**ï¼šæ˜“äºŽæ·»åŠ æ–°çš„ UI ç»„ä»¶
- **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ¨¡å—è¾¹ç•Œå’Œäº¤äº’å¥‘çº¦

## ðŸ“ **æŠ€æœ¯å€ºåŠ¡æ›´æ–°**

### âœ… **å·²å®Œå…¨è§£å†³**

- âœ… TooltipManager ä¸­çš„å¾ªçŽ¯ä¾èµ–
- âœ… ToolpopupManager ä¸­çš„åŠ¨æ€å¯¼å…¥
- âœ… ç›´æŽ¥ç»„ä»¶è°ƒç”¨çš„ç´§è€¦åˆ
- âœ… ç¼ºå°‘ç»Ÿä¸€çš„äº‹ä»¶ç®¡ç†
- âœ… ç±»åž‹å®‰å…¨é—®é¢˜

### ðŸŽ¯ **æ–°çš„æŠ€æœ¯ä¼˜åŠ¿**

- âœ… å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æž¶æž„
- âœ… ç±»åž‹å®‰å…¨çš„ç»„ä»¶é€šä¿¡
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… å®Œå–„çš„èµ„æºç®¡ç†
- âœ… æ˜“äºŽè°ƒè¯•çš„æ—¥å¿—ç³»ç»Ÿ

## ðŸ† **é¡¹ç›®é‡Œç¨‹ç¢‘**

### ðŸŽ¯ **é‡å¤§æˆå°±**

1. **âœ… å®Œå…¨è§£å†³å¾ªçŽ¯ä¾èµ–é—®é¢˜**
2. **âœ… å»ºç«‹äº‹ä»¶é©±åŠ¨æž¶æž„**
3. **âœ… æå‡ä»£ç è´¨é‡åˆ°ç”Ÿäº§çº§åˆ«**
4. **âœ… å®žçŽ°100%æµ‹è¯•é€šè¿‡çŽ‡**
5. **âœ… ä¿æŒç”¨æˆ·ä½“éªŒæ— é€€åŒ–**

### ðŸ“ˆ **è´¨é‡æŒ‡æ ‡è¾¾æˆ**

- **å¾ªçŽ¯ä¾èµ–**ï¼š0ä¸ª (ç›®æ ‡: 0ä¸ª) âœ…
- **TypeScript ç¼–è¯‘**ï¼š0è­¦å‘Š (ç›®æ ‡: 0è­¦å‘Š) âœ…
- **æµ‹è¯•è¦†ç›–çŽ‡**ï¼š100% (ç›®æ ‡: >90%) âœ…
- **æ€§èƒ½é€€åŒ–**ï¼š0% (ç›®æ ‡: <5%) âœ…
- **ä»£ç å¤æ‚åº¦**ï¼šæ˜¾è‘—é™ä½Ž âœ…

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024-01-XX  
**æŠ¥å‘Šä½œè€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**å®¡æŸ¥çŠ¶æ€**ï¼šå·²å®Œæˆ  
**é¡¹ç›®çŠ¶æ€**ï¼šå¾ªçŽ¯ä¾èµ–é—®é¢˜å®Œå…¨è§£å†³ ðŸŽ‰
