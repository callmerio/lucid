# F2_技术架构.md - Lucid 浏览器扩展

## 🏗️ 系统架构

### 整体架构模式
```
┌─────────────────────────────────────────────────────────────┐
│                    Lucid Browser Extension                  │
├─────────────────────────────────────────────────────────────┤
│  Frontend Layer (React 19 + TypeScript)                    │
│  ├── Popup Interface     ├── Options Page                  │
│  ├── Content Scripts     ├── DevTools Panel                │
│  └── Background Service  └── Context Menus                 │
├─────────────────────────────────────────────────────────────┤
│  Service Layer                                              │
│  ├── Dictionary API      ├── Cache Service                 │
│  ├── Storage Service     ├── Sync Service                  │
│  └── Highlight Service   └── Analytics Service             │
├─────────────────────────────────────────────────────────────┤
│  Data Layer                                                 │
│  ├── Browser Storage     ├── IndexedDB                     │
│  ├── Memory Cache        └── External APIs                 │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件架构

#### WebExtension 架构
```
Background Script (Service Worker)
├── API Communication Hub
├── Storage Management
├── Cross-tab Synchronization
└── Context Menu Handlers

Content Scripts (Per Tab)
├── DOM Manipulation
├── Text Selection Handling
├── Highlight Rendering
└── User Interaction Events

Popup Interface
├── Word Lookup UI
├── Highlight Management
├── Settings Panel
└── Statistics Dashboard
```

## 💾 数据模型

### 核心数据结构

#### HighlightData
```typescript
interface HighlightData {
  id: string;              // 唯一标识符
  text: string;            // 高亮文本内容
  color: string;           // 高亮颜色
  count: number;           // 标记次数
  timestamp: number;       // 创建时间戳
  url: string;             // 页面URL
  selector: string;        // DOM选择器
  position: {              // 位置信息
    start: number;
    end: number;
  };
  metadata?: {             // 扩展元数据
    category?: string;
    tags?: string[];
    notes?: string;
  };
}
```

#### WordDefinition
```typescript
interface WordDefinition {
  word: string;            // 单词
  phonetic: string;        // 音标
  definitions: Array<{     // 定义列表
    partOfSpeech: string;  // 词性
    definition: string;    // 释义
    example?: string;      // 例句
  }>;
  audio?: string;          // 发音音频URL
  frequency: number;       // 查询频率
  lastQueried: number;     // 最后查询时间
}
```

#### UserSettings
```typescript
interface UserSettings {
  theme: "light" | "dark" | "auto";
  highlightColor: string;
  enableShortcuts: boolean;
  autoExpand: boolean;
  showTooltips: boolean;
  syncEnabled: boolean;
  apiEndpoint?: string;
  cacheExpiry: number;
}
```

## 🔄 核心工作流

### 高亮工作流
```
1. 用户选择文本
   ↓
2. 智能边界扩展 (selectionUtils.ts)
   ↓
3. 检查现有高亮 (highlightStorage.ts)
   ↓
4. 计算颜色梯度 (highlightUtils.ts)
   ↓
5. 应用DOM高亮 (highlightUtils.ts)
   ↓
6. 持久化存储 (highlightStorage.ts)
   ↓
7. 同步到其他标签页
```

### 查词工作流
```
1. 触发查词事件 (双击/快捷键)
   ↓
2. 提取目标单词 (selectionUtils.ts)
   ↓
3. 检查本地缓存 (cacheService.ts)
   ↓
4. 缓存未命中 → API请求 (dictionaryApi.ts)
   ↓
5. 解析API响应
   ↓
6. 更新本地缓存
   ↓
7. 显示查词结果 (Popup/Tooltip)
   ↓
8. 记录查询历史
```

### 数据同步工作流
```
1. 本地数据变更检测
   ↓
2. 数据序列化和压缩
   ↓
3. 冲突检测和解决
   ↓
4. 上传到云端存储
   ↓
5. 广播更新事件
   ↓
6. 其他设备接收同步
```

## 🔒 安全设计

### 数据安全
- **本地存储加密**: 敏感数据使用AES加密
- **API通信安全**: HTTPS + API密钥认证
- **权限最小化**: 仅请求必要的浏览器权限
- **数据隔离**: 不同网站的数据独立存储

### 隐私保护
- **用户数据控制**: 用户完全控制数据的存储和删除
- **匿名化统计**: 统计数据不包含个人身份信息
- **透明度**: 清晰的隐私政策和数据使用说明

### 安全最佳实践
- **输入验证**: 所有用户输入严格验证和清理
- **XSS防护**: DOM操作使用安全的API
- **CSP策略**: 严格的内容安全策略
- **定期安全审计**: 代码和依赖的安全扫描

## 🚀 性能优化设计

### 前端性能
- **懒加载**: 组件和资源按需加载
- **虚拟化**: 大列表使用虚拟滚动
- **防抖节流**: 用户交互事件优化
- **内存管理**: 及时清理事件监听器和DOM引用

### 存储性能
- **数据压缩**: 存储数据使用压缩算法
- **索引优化**: IndexedDB查询索引优化
- **缓存策略**: 多层缓存机制
- **批量操作**: 减少存储API调用次数

### 网络性能
- **请求合并**: 批量API请求
- **缓存策略**: 智能缓存和过期策略
- **离线支持**: 关键功能离线可用
- **错误重试**: 网络错误自动重试机制

## 🔧 扩展性设计

### 模块化架构
- **插件系统**: 支持功能模块的动态加载
- **主题系统**: 可扩展的UI主题框架
- **API抽象**: 统一的外部服务接口
- **配置驱动**: 功能开关和参数配置

### 国际化支持
- **多语言**: i18n框架支持多语言
- **本地化**: 日期、数字格式本地化
- **RTL支持**: 右到左语言布局支持
- **字体适配**: 不同语言的字体优化

### 平台扩展
- **跨浏览器**: 统一的WebExtension API抽象
- **移动端**: 响应式设计支持移动浏览器
- **桌面应用**: Electron包装的桌面版本
- **Web版本**: 独立的Web应用版本
