# F2_æŠ€æœ¯æ¶æ„.md - Lucid æµè§ˆå™¨æ‰©å±•

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„æ¨¡å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lucid Browser Extension                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frontend Layer (React 19 + TypeScript)                    â”‚
â”‚  â”œâ”€â”€ Popup Interface     â”œâ”€â”€ Options Page                  â”‚
â”‚  â”œâ”€â”€ Content Scripts     â”œâ”€â”€ DevTools Panel                â”‚
â”‚  â””â”€â”€ Background Service  â””â”€â”€ Context Menus                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Service Layer                                              â”‚
â”‚  â”œâ”€â”€ Dictionary API      â”œâ”€â”€ Cache Service                 â”‚
â”‚  â”œâ”€â”€ Storage Service     â”œâ”€â”€ Sync Service                  â”‚
â”‚  â””â”€â”€ Highlight Service   â””â”€â”€ Analytics Service             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer                                                 â”‚
â”‚  â”œâ”€â”€ Browser Storage     â”œâ”€â”€ IndexedDB                     â”‚
â”‚  â”œâ”€â”€ Memory Cache        â””â”€â”€ External APIs                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶æ¶æ„

#### WebExtension æ¶æ„
```
Background Script (Service Worker)
â”œâ”€â”€ API Communication Hub
â”œâ”€â”€ Storage Management
â”œâ”€â”€ Cross-tab Synchronization
â””â”€â”€ Context Menu Handlers

Content Scripts (Per Tab)
â”œâ”€â”€ DOM Manipulation
â”œâ”€â”€ Text Selection Handling
â”œâ”€â”€ Highlight Rendering
â””â”€â”€ User Interaction Events

Popup Interface
â”œâ”€â”€ Word Lookup UI
â”œâ”€â”€ Highlight Management
â”œâ”€â”€ Settings Panel
â””â”€â”€ Statistics Dashboard
```

## ğŸ’¾ æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ•°æ®ç»“æ„

#### HighlightData
```typescript
interface HighlightData {
  id: string;              // å”¯ä¸€æ ‡è¯†ç¬¦
  text: string;            // é«˜äº®æ–‡æœ¬å†…å®¹
  color: string;           // é«˜äº®é¢œè‰²
  count: number;           // æ ‡è®°æ¬¡æ•°
  timestamp: number;       // åˆ›å»ºæ—¶é—´æˆ³
  url: string;             // é¡µé¢URL
  selector: string;        // DOMé€‰æ‹©å™¨
  position: {              // ä½ç½®ä¿¡æ¯
    start: number;
    end: number;
  };
  metadata?: {             // æ‰©å±•å…ƒæ•°æ®
    category?: string;
    tags?: string[];
    notes?: string;
  };
}
```

#### WordDefinition
```typescript
interface WordDefinition {
  word: string;            // å•è¯
  phonetic: string;        // éŸ³æ ‡
  definitions: Array<{     // å®šä¹‰åˆ—è¡¨
    partOfSpeech: string;  // è¯æ€§
    definition: string;    // é‡Šä¹‰
    example?: string;      // ä¾‹å¥
  }>;
  audio?: string;          // å‘éŸ³éŸ³é¢‘URL
  frequency: number;       // æŸ¥è¯¢é¢‘ç‡
  lastQueried: number;     // æœ€åæŸ¥è¯¢æ—¶é—´
}
```

#### UserSettings
```typescript
interface UserSettings {
  theme: "light" | "dark" | "auto";
  highlightColor: string;
  enableShortcuts: boolean;
  autoExpand: boolean;
  showTooltips: boolean;
  syncEnabled: boolean;
  apiEndpoint?: string;
  cacheExpiry: number;
}
```

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµ

### é«˜äº®å·¥ä½œæµ
```
1. ç”¨æˆ·é€‰æ‹©æ–‡æœ¬
   â†“
2. æ™ºèƒ½è¾¹ç•Œæ‰©å±• (selectionUtils.ts)
   â†“
3. æ£€æŸ¥ç°æœ‰é«˜äº® (highlightStorage.ts)
   â†“
4. è®¡ç®—é¢œè‰²æ¢¯åº¦ (highlightUtils.ts)
   â†“
5. åº”ç”¨DOMé«˜äº® (highlightUtils.ts)
   â†“
6. æŒä¹…åŒ–å­˜å‚¨ (highlightStorage.ts)
   â†“
7. åŒæ­¥åˆ°å…¶ä»–æ ‡ç­¾é¡µ
```

### æŸ¥è¯å·¥ä½œæµ
```
1. è§¦å‘æŸ¥è¯äº‹ä»¶ (åŒå‡»/å¿«æ·é”®)
   â†“
2. æå–ç›®æ ‡å•è¯ (selectionUtils.ts)
   â†“
3. æ£€æŸ¥æœ¬åœ°ç¼“å­˜ (cacheService.ts)
   â†“
4. ç¼“å­˜æœªå‘½ä¸­ â†’ APIè¯·æ±‚ (dictionaryApi.ts)
   â†“
5. è§£æAPIå“åº”
   â†“
6. æ›´æ–°æœ¬åœ°ç¼“å­˜
   â†“
7. æ˜¾ç¤ºæŸ¥è¯ç»“æœ (Popup/Tooltip)
   â†“
8. è®°å½•æŸ¥è¯¢å†å²
```

### æ•°æ®åŒæ­¥å·¥ä½œæµ
```
1. æœ¬åœ°æ•°æ®å˜æ›´æ£€æµ‹
   â†“
2. æ•°æ®åºåˆ—åŒ–å’Œå‹ç¼©
   â†“
3. å†²çªæ£€æµ‹å’Œè§£å†³
   â†“
4. ä¸Šä¼ åˆ°äº‘ç«¯å­˜å‚¨
   â†“
5. å¹¿æ’­æ›´æ–°äº‹ä»¶
   â†“
6. å…¶ä»–è®¾å¤‡æ¥æ”¶åŒæ­¥
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### æ•°æ®å®‰å…¨
- **æœ¬åœ°å­˜å‚¨åŠ å¯†**: æ•æ„Ÿæ•°æ®ä½¿ç”¨AESåŠ å¯†
- **APIé€šä¿¡å®‰å…¨**: HTTPS + APIå¯†é’¥è®¤è¯
- **æƒé™æœ€å°åŒ–**: ä»…è¯·æ±‚å¿…è¦çš„æµè§ˆå™¨æƒé™
- **æ•°æ®éš”ç¦»**: ä¸åŒç½‘ç«™çš„æ•°æ®ç‹¬ç«‹å­˜å‚¨

### éšç§ä¿æŠ¤
- **ç”¨æˆ·æ•°æ®æ§åˆ¶**: ç”¨æˆ·å®Œå…¨æ§åˆ¶æ•°æ®çš„å­˜å‚¨å’Œåˆ é™¤
- **åŒ¿ååŒ–ç»Ÿè®¡**: ç»Ÿè®¡æ•°æ®ä¸åŒ…å«ä¸ªäººèº«ä»½ä¿¡æ¯
- **é€æ˜åº¦**: æ¸…æ™°çš„éšç§æ”¿ç­–å’Œæ•°æ®ä½¿ç”¨è¯´æ˜

### å®‰å…¨æœ€ä½³å®è·µ
- **è¾“å…¥éªŒè¯**: æ‰€æœ‰ç”¨æˆ·è¾“å…¥ä¸¥æ ¼éªŒè¯å’Œæ¸…ç†
- **XSSé˜²æŠ¤**: DOMæ“ä½œä½¿ç”¨å®‰å…¨çš„API
- **CSPç­–ç•¥**: ä¸¥æ ¼çš„å†…å®¹å®‰å…¨ç­–ç•¥
- **å®šæœŸå®‰å…¨å®¡è®¡**: ä»£ç å’Œä¾èµ–çš„å®‰å…¨æ‰«æ

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è®¾è®¡

### å‰ç«¯æ€§èƒ½
- **æ‡’åŠ è½½**: ç»„ä»¶å’Œèµ„æºæŒ‰éœ€åŠ è½½
- **è™šæ‹ŸåŒ–**: å¤§åˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
- **é˜²æŠ–èŠ‚æµ**: ç”¨æˆ·äº¤äº’äº‹ä»¶ä¼˜åŒ–
- **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’ŒDOMå¼•ç”¨

### å­˜å‚¨æ€§èƒ½
- **æ•°æ®å‹ç¼©**: å­˜å‚¨æ•°æ®ä½¿ç”¨å‹ç¼©ç®—æ³•
- **ç´¢å¼•ä¼˜åŒ–**: IndexedDBæŸ¥è¯¢ç´¢å¼•ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: å¤šå±‚ç¼“å­˜æœºåˆ¶
- **æ‰¹é‡æ“ä½œ**: å‡å°‘å­˜å‚¨APIè°ƒç”¨æ¬¡æ•°

### ç½‘ç»œæ€§èƒ½
- **è¯·æ±‚åˆå¹¶**: æ‰¹é‡APIè¯·æ±‚
- **ç¼“å­˜ç­–ç•¥**: æ™ºèƒ½ç¼“å­˜å’Œè¿‡æœŸç­–ç•¥
- **ç¦»çº¿æ”¯æŒ**: å…³é”®åŠŸèƒ½ç¦»çº¿å¯ç”¨
- **é”™è¯¯é‡è¯•**: ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•æœºåˆ¶

## ğŸ”§ æ‰©å±•æ€§è®¾è®¡

### æ¨¡å—åŒ–æ¶æ„
- **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒåŠŸèƒ½æ¨¡å—çš„åŠ¨æ€åŠ è½½
- **ä¸»é¢˜ç³»ç»Ÿ**: å¯æ‰©å±•çš„UIä¸»é¢˜æ¡†æ¶
- **APIæŠ½è±¡**: ç»Ÿä¸€çš„å¤–éƒ¨æœåŠ¡æ¥å£
- **é…ç½®é©±åŠ¨**: åŠŸèƒ½å¼€å…³å’Œå‚æ•°é…ç½®

### å›½é™…åŒ–æ”¯æŒ
- **å¤šè¯­è¨€**: i18næ¡†æ¶æ”¯æŒå¤šè¯­è¨€
- **æœ¬åœ°åŒ–**: æ—¥æœŸã€æ•°å­—æ ¼å¼æœ¬åœ°åŒ–
- **RTLæ”¯æŒ**: å³åˆ°å·¦è¯­è¨€å¸ƒå±€æ”¯æŒ
- **å­—ä½“é€‚é…**: ä¸åŒè¯­è¨€çš„å­—ä½“ä¼˜åŒ–

### å¹³å°æ‰©å±•
- **è·¨æµè§ˆå™¨**: ç»Ÿä¸€çš„WebExtension APIæŠ½è±¡
- **ç§»åŠ¨ç«¯**: å“åº”å¼è®¾è®¡æ”¯æŒç§»åŠ¨æµè§ˆå™¨
- **æ¡Œé¢åº”ç”¨**: ElectronåŒ…è£…çš„æ¡Œé¢ç‰ˆæœ¬
- **Webç‰ˆæœ¬**: ç‹¬ç«‹çš„Webåº”ç”¨ç‰ˆæœ¬
