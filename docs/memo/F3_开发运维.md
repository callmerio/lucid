# F3_开发运维.md - Lucid 浏览器扩展

## 🔧 环境设置

### 开发环境要求
```bash
# 基础环境
Node.js >= 18.0.0
pnpm >= 8.0.0
Git >= 2.30.0

# 推荐IDE
VS Code + 扩展包:
├── TypeScript and JavaScript Language Features
├── ES7+ React/Redux/React-Native snippets
├── Tailwind CSS IntelliSense
├── ESLint
├── Prettier
└── WXT Extension Development
```

### 快速启动
```bash
# 克隆项目
git clone <repository-url>
cd lucid

# 安装依赖
pnpm install

# 开发模式 (Chrome)
pnpm dev

# 开发模式 (Firefox)
pnpm dev:firefox

# 构建生产版本
pnpm build

# 运行测试
pnpm test
```

### 环境配置文件
```
.env.development     # 开发环境配置
.env.production      # 生产环境配置
.env.local          # 本地覆盖配置 (git ignored)

# 示例配置
API_ENDPOINT=https://api.lucid.dev
CACHE_EXPIRY=3600000
DEBUG_MODE=true
```

## 📂 项目结构

### 目录组织
```
lucid/
├── docs/                    # 项目文档
│   ├── riper/              # RIPER系统文档
│   ├── architecture/       # 架构设计文档
│   └── api/                # API文档
├── src/                    # 源代码目录
│   ├── components/         # React组件
│   │   ├── features/       # 功能组件
│   │   ├── ui/            # 基础UI组件
│   │   └── layout/        # 布局组件
│   ├── services/          # 业务服务层
│   │   ├── api/           # API客户端
│   │   ├── storage/       # 存储服务
│   │   └── cache/         # 缓存服务
│   ├── utils/             # 工具函数
│   │   ├── dom/           # DOM操作
│   │   ├── text/          # 文本处理
│   │   └── highlight/     # 高亮逻辑
│   ├── types/             # TypeScript类型
│   ├── styles/            # 样式文件
│   └── tests/             # 测试文件
├── entrypoints/           # WXT入口点
│   ├── background.ts      # 后台脚本
│   ├── content.ts         # 内容脚本
│   └── popup/             # 弹窗界面
├── assets/                # 静态资源
├── utils/                 # 全局工具函数
└── public/                # 公共资源
```

### 代码组织原则
- **功能优先**: 按功能模块组织代码
- **层次分离**: 清晰的架构层次
- **单一职责**: 每个模块职责明确
- **依赖管理**: 合理的依赖关系

## 🧪 测试策略

### 测试框架配置
```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/tests/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      threshold: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80
        }
      }
    }
  }
});
```

### 测试分层策略

#### 单元测试 (Unit Tests)
```bash
# 工具函数测试
src/utils/**/*.test.ts

# 组件测试
src/components/**/*.test.tsx

# 服务测试
src/services/**/*.test.ts

# 运行单元测试
pnpm test:unit
```

#### 集成测试 (Integration Tests)
```bash
# API集成测试
src/tests/integration/api.test.ts

# 存储集成测试
src/tests/integration/storage.test.ts

# 运行集成测试
pnpm test:integration
```

#### E2E测试 (End-to-End Tests)
```bash
# 使用Playwright进行E2E测试
tests/e2e/highlight.spec.ts
tests/e2e/lookup.spec.ts

# 运行E2E测试
pnpm test:e2e
```

### 测试覆盖率目标
- **代码覆盖率**: > 80%
- **分支覆盖率**: > 75%
- **函数覆盖率**: > 85%
- **关键路径**: 100%

## 🚀 部署流程

### 构建流程
```bash
# 1. 代码质量检查
pnpm lint
pnpm type-check
pnpm test:run

# 2. 构建生产版本
pnpm build

# 3. 生成发布包
pnpm zip

# 4. 版本标记
git tag v1.0.0
git push origin v1.0.0
```

### 发布渠道

#### Chrome Web Store
```bash
# 构建Chrome版本
pnpm build

# 上传到Chrome Web Store
# 使用Chrome Developer Dashboard
```

#### Firefox Add-ons
```bash
# 构建Firefox版本
pnpm build:firefox

# 上传到Firefox Add-ons
# 使用Firefox Developer Hub
```

#### 内部分发
```bash
# 生成开发者版本
pnpm build --mode development

# 打包分发文件
pnpm zip:dev
```

### CI/CD 流程
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm test:run
      - run: pnpm build

  release:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - run: pnpm zip
      - uses: actions/upload-artifact@v3
        with:
          name: extension-build
          path: .output/*.zip
```

## 🔍 监控和调试

### 开发调试
```javascript
// 开发环境调试配置
if (import.meta.env.DEV) {
  // 启用详细日志
  console.debug('Lucid Extension: Debug mode enabled');
  
  // 性能监控
  performance.mark('extension-start');
  
  // 错误追踪
  window.addEventListener('error', (e) => {
    console.error('Extension Error:', e);
  });
}
```

### 生产监控
```typescript
// 错误报告服务
class ErrorReporter {
  static report(error: Error, context: string) {
    // 发送错误报告到监控服务
    if (import.meta.env.PROD) {
      // 实际的错误报告逻辑
    }
  }
}

// 性能监控
class PerformanceMonitor {
  static trackTiming(name: string, duration: number) {
    // 记录性能指标
  }
  
  static trackMemory() {
    // 监控内存使用
  }
}
```

### 日志管理
```typescript
// 统一日志系统
class Logger {
  static debug(message: string, data?: any) {
    if (import.meta.env.DEV) {
      console.debug(`[Lucid] ${message}`, data);
    }
  }
  
  static info(message: string, data?: any) {
    console.info(`[Lucid] ${message}`, data);
  }
  
  static error(message: string, error?: Error) {
    console.error(`[Lucid] ${message}`, error);
    ErrorReporter.report(error, message);
  }
}
```

## 🔧 开发工具配置

### VS Code 配置
```json
// .vscode/settings.json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "tailwindCSS.experimental.classRegex": [
    ["clsx\\(([^)]*)\\)", "(?:'|\"|`)([^']*)(?:'|\"|`)"]
  ]
}
```

### Git Hooks
```bash
# .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm lint-staged
pnpm type-check

# .husky/commit-msg
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm commitlint --edit $1
```

### 代码质量工具
```json
// package.json scripts
{
  "lint": "eslint . --ext .ts,.tsx,.js,.jsx",
  "lint:fix": "eslint . --ext .ts,.tsx,.js,.jsx --fix",
  "format": "prettier --write .",
  "format:check": "prettier --check .",
  "type-check": "tsc --noEmit"
}
```
