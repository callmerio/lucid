# ğŸ—ï¸ F2_æŠ€æœ¯æ¶æ„.md

## ğŸ“ ç³»ç»Ÿåˆ†å±‚æ¶æ„

```mermaid
graph TB
    subgraph "æµè§ˆå™¨å±‚"
        A[Content Script] --> B[Background Script]
        C[Popup UI] --> B
        D[Options Page] --> B
    end
    
    subgraph "åº”ç”¨å±‚"
        E[React Components] --> F[Hooks Layer]
        F --> G[Service Layer]
        G --> H[Utils Layer]
    end
    
    subgraph "æ•°æ®å±‚"
        I[Browser Storage] --> J[Cache Layer]
        K[External APIs] --> J
    end
    
    A --> E
    B --> G
    G --> I
    G --> K
```

## ğŸ—‚ï¸ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### ğŸ“± UIç»„ä»¶æ¶æ„
```
src/components/
â”œâ”€â”€ tooltip/           # Tooltipç³»ç»Ÿ
â”‚   â”œâ”€â”€ BasicTooltip   # åŸºç¡€æ‚¬åœæç¤º
â”‚   â”œâ”€â”€ DetailedPopup  # è¯¦ç»†ä¿¡æ¯å¼¹çª—
â”‚   â””â”€â”€ TooltipManager # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ highlight/         # é«˜äº®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ WordHighlight  # è¯æ±‡é«˜äº®
â”‚   â”œâ”€â”€ GradientColor  # æ¸å˜è‰²å½©
â”‚   â””â”€â”€ SelectionUI    # é€‰æ‹©ç•Œé¢
â””â”€â”€ common/           # é€šç”¨ç»„ä»¶
    â”œâ”€â”€ Button        # æŒ‰é’®ç»„ä»¶
    â”œâ”€â”€ Icon          # å›¾æ ‡ç»„ä»¶
    â””â”€â”€ Card          # å¡ç‰‡ç»„ä»¶
```

### ğŸ”§ æœåŠ¡å±‚æ¶æ„
```
src/services/
â”œâ”€â”€ dictionary/       # è¯å…¸æœåŠ¡
â”‚   â”œâ”€â”€ api.ts       # APIæ¥å£
â”‚   â”œâ”€â”€ cache.ts     # ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ parser.ts    # æ•°æ®è§£æ
â”œâ”€â”€ highlight/       # é«˜äº®æœåŠ¡
â”‚   â”œâ”€â”€ detector.ts  # æ–‡æœ¬æ£€æµ‹
â”‚   â”œâ”€â”€ renderer.ts  # æ¸²æŸ“å¼•æ“
â”‚   â””â”€â”€ manager.ts   # çŠ¶æ€ç®¡ç†
â””â”€â”€ storage/         # å­˜å‚¨æœåŠ¡
    â”œâ”€â”€ local.ts     # æœ¬åœ°å­˜å‚¨
    â”œâ”€â”€ sync.ts      # åŒæ­¥å­˜å‚¨
    â””â”€â”€ cache.ts     # ç¼“å­˜ç­–ç•¥
```

## ğŸ’¾ æ•°æ®æ¨¡å‹è®¾è®¡

### è¯æ±‡æ•°æ®æ¨¡å‹
```typescript
interface WordData {
  word: string;              // åŸè¯
  syllables: string[];       // éŸ³èŠ‚åˆ†å‰²
  phonetic: string[];        // éŸ³æ ‡ (å¯å¤šä¸ª)
  definitions: Definition[]; // å®šä¹‰åˆ—è¡¨
  examples: Example[];       // ä¾‹å¥
  frequency: number;         // ä½¿ç”¨é¢‘ç‡
  lastAccessed: Date;        // æœ€åè®¿é—®æ—¶é—´
}

interface Definition {
  partOfSpeech: string;     // è¯æ€§
  meaning: string;          // å«ä¹‰
  short_chinese: string;    // ä¸­æ–‡ç®€é‡Š
  context: string[];        // ä¸Šä¸‹æ–‡æ ‡ç­¾
}
```

### é«˜äº®çŠ¶æ€æ¨¡å‹
```typescript
interface HighlightState {
  selectedWords: Set<string>;    // å·²é€‰è¯æ±‡
  gradientMap: Map<string, RGB>; // é¢œè‰²æ˜ å°„
  hoverZones: HoverZone[];       // æ‚¬åœåŒºåŸŸ
  tooltipState: TooltipState;    // TooltipçŠ¶æ€
}

interface TooltipState {
  isVisible: boolean;
  position: Position;
  content: WordData | null;
  stage: 'basic' | 'detailed';  // ä¸¤é˜¶æ®µçŠ¶æ€
}
```

## ğŸ—„ï¸ ç¼“å­˜ç­–ç•¥

### å¤šçº§ç¼“å­˜æ¶æ„
```
Level 1: å†…å­˜ç¼“å­˜ (Map/Set)
â”œâ”€â”€ è¯æ±‡æ•°æ®ç¼“å­˜ (æœ€è¿‘1000ä¸ª)
â”œâ”€â”€ æ¸²æŸ“ç»“æœç¼“å­˜ (DOMç‰‡æ®µ)
â””â”€â”€ è®¡ç®—ç»“æœç¼“å­˜ (é¢œè‰²/ä½ç½®)

Level 2: æµè§ˆå™¨å­˜å‚¨
â”œâ”€â”€ chrome.storage.local (æŒä¹…åŒ–æ•°æ®)
â”œâ”€â”€ chrome.storage.sync (ç”¨æˆ·è®¾ç½®)
â””â”€â”€ IndexedDB (å¤§é‡æ•°æ®å­˜å‚¨)

Level 3: ç½‘ç»œç¼“å­˜
â”œâ”€â”€ APIå“åº”ç¼“å­˜ (24å°æ—¶)
â”œâ”€â”€ é™æ€èµ„æºç¼“å­˜ (æ°¸ä¹…)
â””â”€â”€ é¢„åŠ è½½ç¼“å­˜ (é¢„æµ‹æ€§)
```

### ç¼“å­˜ç­–ç•¥
- **LRUæ·˜æ±°** - æœ€è¿‘æœ€å°‘ä½¿ç”¨ä¼˜å…ˆæ·˜æ±°
- **TTLè¿‡æœŸ** - æ—¶é—´æˆ³è‡ªåŠ¨è¿‡æœŸ
- **å®¹é‡é™åˆ¶** - å†…å­˜ä½¿ç”¨ä¸Šé™æ§åˆ¶
- **æ™ºèƒ½é¢„åŠ è½½** - åŸºäºç”¨æˆ·è¡Œä¸ºé¢„æµ‹

## ğŸ”„ æ ¸å¿ƒæµç¨‹

### è¯æ±‡é«˜äº®æµç¨‹
```mermaid
sequenceDiagram
    participant U as User
    participant C as Content Script
    participant H as Highlight Service
    participant D as Dictionary Service
    participant S as Storage
    
    U->>C: é¡µé¢åŠ è½½
    C->>H: åˆå§‹åŒ–é«˜äº®æ£€æµ‹
    H->>C: æ‰«ææ–‡æœ¬èŠ‚ç‚¹
    C->>D: æ‰¹é‡æŸ¥è¯¢è¯æ±‡
    D->>S: æ£€æŸ¥ç¼“å­˜
    S-->>D: è¿”å›ç¼“å­˜æ•°æ®
    D->>C: è¿”å›è¯æ±‡ä¿¡æ¯
    C->>H: æ¸²æŸ“é«˜äº®æ•ˆæœ
    H->>U: æ˜¾ç¤ºé«˜äº®æ–‡æœ¬
```

### Tooltipäº¤äº’æµç¨‹
```mermaid
stateDiagram-v2
    [*] --> Hidden
    Hidden --> BasicTooltip: é¼ æ ‡æ‚¬åœ
    BasicTooltip --> Hidden: é¼ æ ‡ç¦»å¼€
    BasicTooltip --> DetailedPopup: Shifté”®æŒ‰ä¸‹
    DetailedPopup --> BasicTooltip: Shifté”®é‡Šæ”¾
    DetailedPopup --> Hidden: ç‚¹å‡»å¤–éƒ¨
```

## ğŸ”Œ APIæ¥å£è§„èŒƒ

### å†…éƒ¨API
```typescript
// è¯å…¸æœåŠ¡API
interface DictionaryAPI {
  lookup(word: string): Promise<WordData>;
  batchLookup(words: string[]): Promise<WordData[]>;
  getSuggestions(prefix: string): Promise<string[]>;
}

// é«˜äº®æœåŠ¡API
interface HighlightAPI {
  highlightWord(word: string, element: Element): void;
  removeHighlight(word: string): void;
  updateGradient(words: string[]): void;
}

// å­˜å‚¨æœåŠ¡API
interface StorageAPI {
  get<T>(key: string): Promise<T | null>;
  set<T>(key: string, value: T): Promise<void>;
  remove(key: string): Promise<void>;
  clear(): Promise<void>;
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### æ¸²æŸ“ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨** - å¤§é‡å†…å®¹åˆ†é¡µæ¸²æŸ“
- **é˜²æŠ–èŠ‚æµ** - é«˜é¢‘äº‹ä»¶ä¼˜åŒ–
- **æ‰¹é‡æ›´æ–°** - DOMæ“ä½œåˆå¹¶
- **æ‡’åŠ è½½** - æŒ‰éœ€åŠ è½½ç»„ä»¶

### å†…å­˜ä¼˜åŒ–
- **å¯¹è±¡æ± ** - é‡ç”¨å¯¹è±¡å®ä¾‹
- **å¼±å¼•ç”¨** - WeakMap/WeakSetä½¿ç”¨
- **åŠæ—¶æ¸…ç†** - äº‹ä»¶ç›‘å¬å™¨æ¸…ç†
- **å†…å­˜ç›‘æ§** - ä½¿ç”¨é‡å®æ—¶ç›‘æ§

### ç½‘ç»œä¼˜åŒ–
- **è¯·æ±‚åˆå¹¶** - æ‰¹é‡APIè°ƒç”¨
- **é¢„åŠ è½½** - æ™ºèƒ½é¢„æµ‹åŠ è½½
- **å‹ç¼©ä¼ è¾“** - Gzip/Brotliå‹ç¼©
- **CDNåŠ é€Ÿ** - é™æ€èµ„æºåˆ†å‘

## ğŸ”’ å®‰å…¨è®¾è®¡

### æ•°æ®å®‰å…¨
- **è¾“å…¥éªŒè¯** - ä¸¥æ ¼å‚æ•°æ ¡éªŒ
- **XSSé˜²æŠ¤** - å†…å®¹å®‰å…¨ç­–ç•¥
- **CSRFé˜²æŠ¤** - è¯·æ±‚ä»¤ç‰ŒéªŒè¯
- **æ•°æ®åŠ å¯†** - æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

### æƒé™æ§åˆ¶
- **æœ€å°æƒé™** - æŒ‰éœ€ç”³è¯·æƒé™
- **æƒé™æ£€æŸ¥** - è¿è¡Œæ—¶æƒé™éªŒè¯
- **å®‰å…¨è¾¹ç•Œ** - æ²™ç®±éš”ç¦»æ‰§è¡Œ
- **å®¡è®¡æ—¥å¿—** - æ“ä½œè®°å½•è¿½è¸ª

---
*æ¶æ„ç‰ˆæœ¬: v1.0 | æœ€åæ›´æ–°: 2024å¹´12æœˆ*
