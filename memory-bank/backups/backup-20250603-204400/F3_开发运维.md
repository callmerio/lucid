# 🛠️ F3_开发运维.md

## 🏗️ 环境搭建

### 系统要求
- **Node.js** >= 18.0.0
- **pnpm** >= 8.0.0 (推荐包管理器)
- **Chrome/Firefox** 开发者版本

### 快速启动
```bash
# 1. 克隆项目
git clone <repository-url>
cd lucid

# 2. 安装依赖
pnpm install

# 3. 启动开发服务器
pnpm dev              # Chrome开发
pnpm dev:firefox      # Firefox开发

# 4. 加载扩展
# Chrome: chrome://extensions/ -> 开发者模式 -> 加载已解压的扩展程序
# Firefox: about:debugging -> 临时加载附加组件
```

### 开发工具配置
```json
// .vscode/settings.json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.tsx": "typescriptreact"
  }
}
```

## 📁 项目结构详解

```
lucid/
├── 📂 src/                    # 源代码目录
│   ├── 📂 components/         # React组件
│   │   ├── tooltip/          # Tooltip系统
│   │   ├── highlight/        # 高亮组件
│   │   └── common/           # 通用组件
│   ├── 📂 services/          # 业务服务层
│   │   ├── dictionary/       # 词典服务
│   │   ├── highlight/        # 高亮服务
│   │   └── storage/          # 存储服务
│   ├── 📂 hooks/             # React Hooks
│   ├── 📂 types/             # TypeScript类型定义
│   ├── 📂 constants/         # 常量定义
│   ├── 📂 lib/               # 工具库
│   └── 📂 styles/            # 样式文件
├── 📂 entrypoints/           # WXT入口点
│   ├── background.ts         # 后台脚本
│   ├── content.ts           # 内容脚本
│   ├── popup/               # 弹窗页面
│   └── options/             # 选项页面
├── 📂 utils/                 # 工具函数
│   ├── dom/                 # DOM操作
│   ├── highlight/           # 高亮工具
│   ├── text/                # 文本处理
│   └── validation/          # 数据验证
├── 📂 assets/               # 静态资源
│   ├── icons/               # 图标文件
│   ├── images/              # 图片资源
│   └── fonts/               # 字体文件
├── 📂 docs/                 # 项目文档
├── 📂 scripts/              # 构建脚本
└── 📂 memory-bank/          # RIPER内存系统
```

## 🔄 开发工作流

### Git工作流
```bash
# 功能开发流程
git checkout -b feature/tooltip-enhancement
# 开发代码...
git add .
git commit -m "✨ feat: tooltip | 添加双阶段tooltip系统"
git push origin feature/tooltip-enhancement
# 创建PR...

# 提交信息规范
✨ feat: 新功能
🐛 fix: 修复bug
📝 docs: 文档更新
🎨 style: 代码格式
♻️ refactor: 重构
⚡ perf: 性能优化
✅ test: 测试相关
🔧 chore: 构建/工具
```

### 代码审查清单
- [ ] **功能完整性** - 是否实现所有需求
- [ ] **代码质量** - ESLint/Prettier检查通过
- [ ] **类型安全** - TypeScript编译无错误
- [ ] **测试覆盖** - 单元测试覆盖率>80%
- [ ] **性能影响** - 无明显性能回归
- [ ] **安全检查** - 无安全漏洞
- [ ] **文档更新** - 相关文档已更新

## 🧪 测试策略

### 测试金字塔
```
        🔺 E2E测试 (5%)
       /              \
      /   集成测试 (15%) \
     /                    \
    /    单元测试 (80%)     \
   /_________________________\
```

### 测试命令
```bash
# 单元测试
pnpm test              # 监听模式
pnpm test:run          # 单次运行
pnpm test:coverage     # 覆盖率报告
pnpm test:ui           # 可视化界面

# E2E测试 (计划中)
pnpm test:e2e          # 端到端测试
pnpm test:e2e:ui       # E2E可视化
```

### 测试文件结构
```
src/tests/
├── unit/              # 单元测试
│   ├── components/    # 组件测试
│   ├── services/      # 服务测试
│   └── utils/         # 工具测试
├── integration/       # 集成测试
├── e2e/              # 端到端测试
└── fixtures/         # 测试数据
```

## 🚀 部署配置

### 构建命令
```bash
# 开发构建
pnpm build             # Chrome版本
pnpm build:firefox     # Firefox版本

# 生产打包
pnpm zip               # Chrome zip包
pnpm zip:firefox       # Firefox zip包

# 质量检查
pnpm lint              # 代码检查
pnpm type-check        # 类型检查
pnpm format:check      # 格式检查
```

### 构建优化
```typescript
// wxt.config.ts 生产优化
export default defineConfig({
  vite: () => ({
    build: {
      minify: 'terser',           // 代码压缩
      sourcemap: false,           // 生产环境关闭sourcemap
      rollupOptions: {
        output: {
          manualChunks: {         // 代码分割
            vendor: ['react', 'react-dom'],
            utils: ['lodash-es']
          }
        }
      }
    }
  })
});
```

## 📊 监控运维

### 性能监控
```typescript
// 性能指标收集
interface PerformanceMetrics {
  highlightTime: number;      // 高亮渲染时间
  tooltipResponseTime: number; // Tooltip响应时间
  memoryUsage: number;        // 内存使用量
  apiLatency: number;         // API延迟
}

// 监控实现
class PerformanceMonitor {
  static measure(name: string, fn: () => void) {
    const start = performance.now();
    fn();
    const end = performance.now();
    console.log(`${name}: ${end - start}ms`);
  }
}
```

### 错误监控
```typescript
// 全局错误处理
window.addEventListener('error', (event) => {
  console.error('Global Error:', {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    stack: event.error?.stack
  });
});

// Promise错误处理
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled Promise Rejection:', event.reason);
});
```

## 🔧 故障处理

### 常见问题解决
```bash
# 依赖问题
rm -rf node_modules pnpm-lock.yaml
pnpm install

# 构建问题
pnpm clean              # 清理构建缓存
pnpm build --verbose    # 详细构建日志

# 类型问题
pnpm type-check         # 检查类型错误
tsc --noEmit --verbose  # 详细类型检查
```

### 调试技巧
```typescript
// 开发环境调试
if (process.env.NODE_ENV === 'development') {
  // 全局调试对象
  (window as any).__LUCID_DEBUG__ = {
    highlightService,
    tooltipManager,
    storageService
  };
}

// 条件断点
console.assert(condition, 'Assertion failed:', data);

// 性能分析
console.time('operation');
// ... 操作代码
console.timeEnd('operation');
```

## 📋 最佳实践

### 代码规范
- **命名约定** - 驼峰命名，语义化
- **文件组织** - 按功能模块分组
- **导入顺序** - 第三方 → 内部 → 相对路径
- **注释规范** - JSDoc格式，中英文结合

### 性能最佳实践
- **避免不必要的重渲染** - React.memo, useMemo
- **批量DOM操作** - DocumentFragment使用
- **事件委托** - 减少事件监听器数量
- **懒加载** - 按需加载组件和资源

### 安全最佳实践
- **输入验证** - 所有用户输入严格验证
- **XSS防护** - 使用dangerouslySetInnerHTML时谨慎
- **CSP策略** - 内容安全策略配置
- **权限最小化** - 只申请必要的浏览器权限

---
*开发指南版本: v1.0 | 最后更新: 2024年12月*
