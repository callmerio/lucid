<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tooltip 高亮状态控制功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .instructions {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .test-text {
            font-size: 16px;
            line-height: 1.8;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .highlight-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
            border-left: 3px solid #ffc107;
        }

        .step-indicator {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .test-word {
            background: #e7f3ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #0066cc;
        }

        kbd {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 12px;
        }

        .expected-result {
            background: #d4edda;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 3px solid #28a745;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid #dee2e6;
        }

        .debug-info h4 {
            color: #495057;
            margin-top: 0;
        }

        .debug-info ul {
            margin: 10px 0;
        }

        .debug-info li {
            margin: 5px 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        #debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-content">
        <h1>🎯 Tooltip 高亮状态控制功能测试</h1>

        <div class="instructions">
            <h3>📋 测试说明</h3>
            <p>本测试验证 tooltip 组件中爱心和下降按钮的高亮状态控制功能。</p>

            <h4>🎯 测试步骤：</h4>
            <ol>
                <li><span class="step-indicator">步骤1</span>选择下面任意一个 <span class="test-word">"JavaScript"</span> 词汇</li>
                <li><span class="step-indicator">步骤2</span>按 <kbd>Shift</kbd> 键进行高亮</li>
                <li><span class="step-indicator">步骤3</span>鼠标悬停在高亮的 <span class="test-word">"JavaScript"</span> 上查看 tooltip</li>
                <li><span class="step-indicator">步骤4</span>观察按钮颜色：下拉箭头应该与高亮颜色一致，爱心应该是红色</li>
                <li><span class="step-indicator">步骤5</span>点击下拉箭头按钮，观察高亮计数减少，tooltip保持显示并更新按钮颜色</li>
                <li><span class="step-indicator">步骤6</span>可以连续点击下拉箭头多次减少计数</li>
                <li><span class="step-indicator">步骤7</span>点击爱心按钮，观察所有高亮被移除，tooltip保持显示但按钮变为灰色</li>
                <li><span class="step-indicator">步骤8</span>🆕 在无高亮状态下，再次点击爱心按钮，观察重新添加高亮（计数为1）</li>
            </ol>

            <div class="expected-result">
                <strong>预期结果：</strong>
                <ul>
                    <li>Tooltip 按钮颜色应该反映当前高亮状态</li>
                    <li>下拉箭头按钮颜色与高亮颜色深度一致</li>
                    <li>爱心按钮在高亮状态下显示为红色</li>
                    <li>点击下拉箭头减少计数，点击爱心完全移除高亮</li>
                    <li>🆕 操作后 tooltip 保持显示，按钮颜色实时更新</li>
                    <li>🆕 可以连续操作，无需重新悬停</li>
                    <li>🆕 高亮完全移除后，按钮变为灰色但仍可见</li>
                    <li>🆕 爱心按钮支持切换：有高亮时移除，无高亮时添加</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>测试文本 1 - 多个 JavaScript 词汇</h3>
            <div class="test-text">
                JavaScript is a versatile programming language. Modern JavaScript frameworks like React and Vue.js make JavaScript development more efficient. Learning JavaScript fundamentals is essential for web development.
            </div>
            <div class="highlight-info">
                💡 这段包含4个"JavaScript"词汇，测试全局同步更新功能
            </div>
        </div>

        <div class="test-section">
            <h3>测试文本 2 - 混合词汇</h3>
            <div class="test-text">
                React is a popular JavaScript library for building user interfaces. TypeScript extends JavaScript by adding static type definitions. Both React and TypeScript are widely used in modern web development.
            </div>
            <div class="highlight-info">
                💡 包含多种词汇，测试不同高亮状态下的按钮颜色
            </div>
        </div>

        <div class="test-section">
            <h3>测试文本 3 - 重复高亮测试</h3>
            <div class="test-text">
                CSS is the language we use to style an HTML document. CSS describes how HTML elements should be displayed. CSS can control the layout of multiple web pages all at once.
            </div>
            <div class="highlight-info">
                💡 多次高亮同一词汇，测试颜色深度变化
            </div>
        </div>

        <div class="debug-info">
            <h4>🔍 调试信息</h4>
            <p><strong>新功能特性：</strong></p>
            <ul>
                <li><strong>状态检测：</strong>自动检测当前单词的高亮状态和计数</li>
                <li><strong>动态颜色：</strong>按钮颜色根据高亮深度动态变化</li>
                <li><strong>交互控制：</strong>下拉箭头减少计数，爱心移除所有高亮</li>
                <li><strong>实时更新：</strong>操作后立即更新所有相同词汇的高亮</li>
                <li><strong>🆕 持续显示：</strong>操作后 tooltip 保持显示，支持连续操作</li>
                <li><strong>🆕 智能刷新：</strong>按钮状态和颜色实时反映最新的高亮状态</li>
                <li><strong>🆕 爱心切换：</strong>爱心按钮支持双向操作（添加/移除高亮）</li>
            </ul>

            <p><strong>检查方法：</strong></p>
            <ul>
                <li>右键点击高亮元素 → 检查元素 → 查看 data-mark-count 属性</li>
                <li>观察 tooltip 按钮的颜色变化</li>
                <li>查看浏览器控制台日志</li>
                <li>测试按钮点击功能</li>
            </ul>

            <button onclick="showHighlightInfo()">显示当前高亮信息</button>
            <button onclick="clearAllHighlights()">清除所有高亮</button>
            <div id="debug-info" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        // 模拟浏览器扩展环境
        if (typeof browser === 'undefined') {
            window.browser = {
                storage: {
                    local: {
                        get: async (keys) => {
                            const result = {};
                            keys.forEach(key => {
                                const stored = localStorage.getItem(`lucid_${key}`);
                                if (stored) {
                                    result[key] = JSON.parse(stored);
                                }
                            });
                            return result;
                        },
                        set: async (data) => {
                            Object.keys(data).forEach(key => {
                                localStorage.setItem(`lucid_${key}`, JSON.stringify(data[key]));
                            });
                        }
                    }
                }
            };
        }

        function showHighlightInfo() {
            const highlights = document.querySelectorAll('.lucid-highlight');
            const info = Array.from(highlights).map(el => ({
                word: el.dataset.word,
                count: el.dataset.markCount,
                baseColor: el.dataset.baseColor,
                text: el.textContent
            }));

            document.getElementById('debug-info').textContent =
                `当前高亮信息 (${highlights.length} 个):\n` +
                JSON.stringify(info, null, 2);
        }

        function clearAllHighlights() {
            document.querySelectorAll('.lucid-highlight').forEach(el => {
                const parent = el.parentNode;
                while (el.firstChild) {
                    parent.insertBefore(el.firstChild, el);
                }
                parent.removeChild(el);
            });
            localStorage.clear();
            document.getElementById('debug-info').textContent = '所有高亮已清除';
        }

        // 监听高亮元素的变化
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE &&
                            node.classList &&
                            node.classList.contains('lucid-highlight')) {
                            console.log('✅ 新高亮元素已添加:', {
                                word: node.dataset.word,
                                markCount: node.dataset.markCount,
                                element: node
                            });
                        }
                    });
                }

                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'data-mark-count') {
                    console.log('📊 高亮计数已更新:', {
                        word: mutation.target.dataset.word,
                        oldCount: mutation.oldValue,
                        newCount: mutation.target.dataset.markCount,
                        element: mutation.target
                    });
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeOldValue: true,
            attributeFilter: ['data-mark-count']
        });
    </script>
</body>
</html>
